# 测试管理模块优化 - 实施进度报告

## 已完成工作（第一阶段：数据模型与后端基础）

### 1. Pydantic数据模型创建 ✅

在 `/data/workspace/rag-studio/backend/app/models/test.py` 中添加了以下新模型：

#### 1.1 检索器评估相关模型
- **ExpectedAnswer**: 期望答案模型（嵌套在RetrieverTestCase中）
  - `answer_text`: 答案文本内容
  - `chunk_id`: 关联的分块ID（可选）
  - `relevance_score`: 关联度分数（0.0-1.0）

- **RetrieverTestCase**: 检索器测试用例模型
  - `test_set_id`: 所属测试集ID
  - `question`: 问题文本内容
  - `expected_answers`: 期望答案列表（JSON数组）
  - `metadata`: 用例元数据

- **RetrieverEvaluationResult**: 检索器评估结果模型
  - `evaluation_task_id`: 评估任务ID
  - `test_case_id`: 测试用例ID
  - `question`: 问题文本（冗余存储便于查询）
  - `expected_answers`: 期望答案列表
  - `retrieved_results`: 检索到的结果列表
  - `retrieval_time`: 检索耗时
  - 评估指标：`precision`, `recall`, `f1_score`, `mrr`, `map_score`, `ndcg`, `hit_rate`

#### 1.2 生成评估相关模型
- **GenerationTestCase**: 生成测试用例模型
  - `test_set_id`: 所属测试集ID
  - `question`: 测试问题
  - `reference_answer`: 参考答案（用于RAGAS评估）
  - `reference_contexts`: 参考上下文列表

- **GenerationEvaluationResult**: 生成评估结果模型
  - `evaluation_task_id`: 评估任务ID
  - `test_case_id`: 测试用例ID
  - `question`: 问题
  - `retrieved_contexts`: 检索到的上下文列表
  - `generated_answer`: 生成的答案
  - `retrieval_time`, `generation_time`: 时间统计
  - `ragas_metrics`: RAGAS评估指标集合（JSON）
  - `llm_model`: 使用的LLM模型

#### 1.3 兼容性处理
- 将原有的 `TestCase` 标记为已废弃，保留用于兼容性
- 将原有的 `RetrievalTestResult` 标记为已废弃，保留用于兼容性
- 将原有的 `GenerationTestResult` 标记为已废弃，保留用于兼容性

### 2. ORM数据模型创建 ✅

在 `/data/workspace/rag-studio/backend/app/database/models.py` 中添加了以下ORM模型：

#### 2.1 新增ORM模型
- **RetrieverTestCaseORM**: 检索器测试用例表
  - 表名: `retriever_test_cases`
  - 索引: `idx_retriever_test_case_test_set` (test_set_id)

- **GenerationTestCaseORM**: 生成测试用例表
  - 表名: `generation_test_cases`
  - 索引: `idx_generation_test_case_test_set` (test_set_id)

- **RetrieverEvaluationResultORM**: 检索器评估结果表
  - 表名: `retriever_evaluation_results`
  - 索引: `idx_retriever_eval_task`, `idx_retriever_eval_test_case`

- **GenerationEvaluationResultORM**: 生成评估结果表
  - 表名: `generation_evaluation_results`
  - 索引: `idx_generation_eval_task`, `idx_generation_eval_test_case`

#### 2.2 兼容性处理
- 将原有的 `TestCaseORM` 标记为已废弃
- 将原有的 `EvaluationCaseResultORM` 标记为已废弃

### 3. 数据库迁移脚本 ✅

创建了新的迁移脚本 `/data/workspace/rag-studio/backend/migrations/002_create_new_test_tables.py`：
- `create_new_tables()`: 创建所有新表
- `drop_new_tables()`: 删除新表（谨慎使用）
- 支持命令行参数控制

### 4. Repository层更新 ✅

#### 4.1 更新MySQLRepository
在 `/data/workspace/rag-studio/backend/app/repositories/mysql_repository.py` 中：
- 更新 `_get_orm_model()` 方法，添加新ORM模型映射
- 支持新的表名映射：
  - `retriever_test_cases` → `RetrieverTestCaseORM`
  - `generation_test_cases` → `GenerationTestCaseORM`
  - `retriever_evaluation_results` → `RetrieverEvaluationResultORM`
  - `generation_evaluation_results` → `GenerationEvaluationResultORM`

#### 4.2 更新RepositoryFactory
在 `/data/workspace/rag-studio/backend/app/repositories/factory.py` 中添加工厂方法：
- `create_retriever_test_case_repository()`: 创建检索器测试用例仓储
- `create_generation_test_case_repository()`: 创建生成测试用例仓储
- `create_retriever_evaluation_result_repository()`: 创建检索器评估结果仓储
- `create_generation_evaluation_result_repository()`: 创建生成评估结果仓储

## 核心改进说明

### 扁平化数据模型设计
根据设计文档要求，采用了扁平化设计：
- **检索器测试用例**：不再使用三表结构（问题表、答案表、关联度表），而是将期望答案直接作为JSON数组存储在测试用例中
- **业务简化**：业务层不需要关注问题ID、答案ID，直接维护问题及其对应的答案列表
- **关联度支持**：每个期望答案都有独立的 `relevance_score`（0.0-1.0），支持分级关联度

### 数据结构示例

检索器测试用例示例：
```json
{
  "id": "rtc_abc123",
  "test_set_id": "ts_001",
  "question": "Python中如何定义一个类？",
  "expected_answers": [
    {
      "answer_text": "在Python中使用class关键字定义类",
      "chunk_id": "chunk_001",
      "relevance_score": 1.0
    },
    {
      "answer_text": "类是面向对象编程的基础",
      "chunk_id": "chunk_002",
      "relevance_score": 0.8
    }
  ],
  "metadata": {"source": "tutorial", "difficulty": "easy"}
}
```

## 下一步工作计划

### 第一阶段剩余任务
1. **执行数据库迁移**
   - 运行迁移脚本创建新表
   - 验证表结构正确性

2. **实现Service层**
   - 创建 `RetrieverTestCaseService`
   - 创建 `GenerationTestCaseService`
   - 创建 `RetrieverEvaluationService`
   - 创建 `GenerationEvaluationService`

3. **实现Controller层（API）**
   - 检索器测试用例管理API（CRUD + 批量导入导出）
   - 生成测试用例管理API（CRUD + 批量导入导出）
   - 评估执行API
   - 评估结果查询API

4. **数据迁移工具**
   - 创建从旧 `TestCase` 迁移到新模型的工具
   - 提供迁移预检查和回滚功能

### 第二阶段：前端界面重构
- 左右分栏布局
- 检索器评估数据管理界面
- 生成评估数据管理界面
- 评估执行向导
- 评估结果展示

### 第三阶段：评估指标计算
- 实现7个检索器评估指标
- 集成RAGAS框架
- 批量评估优化

## 技术要点

### 级联删除
- 删除 `TestSet` 时，级联删除所有关联的测试用例和评估结果
- 删除 `EvaluationTask` 时，级联删除所有评估结果

### 数据验证
- `expected_answers` 数组不能为空（至少1个期望答案）
- `relevance_score` 取值范围：0.0-1.0
- `reference_answer` 为必填字段

### 存储支持
- 支持MySQL数据库存储
- 支持JSON文件存储（开发环境）
- 通过 `RepositoryFactory` 统一创建

## 验证状态

✅ 所有代码文件编译通过，无语法错误
✅ Pydantic模型定义完整，包含示例和验证规则
✅ ORM模型定义完整，包含索引和外键约束
✅ Repository层更新完成，支持新模型
✅ 迁移脚本创建完成，可直接执行

## 文件清单

### 修改的文件
1. `/data/workspace/rag-studio/backend/app/models/test.py` - 添加新Pydantic模型
2. `/data/workspace/rag-studio/backend/app/database/models.py` - 添加新ORM模型
3. `/data/workspace/rag-studio/backend/app/repositories/mysql_repository.py` - 更新ORM映射
4. `/data/workspace/rag-studio/backend/app/repositories/factory.py` - 添加工厂方法

### 新增的文件
1. `/data/workspace/rag-studio/backend/migrations/002_create_new_test_tables.py` - 数据库迁移脚本

## 执行建议

### 立即可执行
```bash
# 1. 创建新数据库表
cd /data/workspace/rag-studio/backend
python migrations/002_create_new_test_tables.py

# 2. 验证表创建成功（如果使用MySQL）
# 检查数据库中是否存在以下表：
# - retriever_test_cases
# - generation_test_cases
# - retriever_evaluation_results
# - generation_evaluation_results
```

### 后续开发顺序
1. 先完成Service层（业务逻辑）
2. 再完成Controller层（API接口）
3. 最后进行前端开发
4. 整体联调测试

---

**备注**：本次实施严格遵循设计文档 `/data/.task/design.md` 的要求，采用扁平化数据模型设计，简化了业务逻辑，提升了查询效率。
