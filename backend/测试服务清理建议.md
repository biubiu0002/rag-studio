# 测试服务清理建议

## 当前问题（已解决）

~~后端存在两套测试用例管理系统：~~
- ~~**旧系统**：`test_service.py` + `test_management.py`（使用已废弃的 `TestCase` 模型）~~
- ~~**新系统**：`new_test_service.py` + `new_test_management.py`（使用 `RetrieverTestCase` 和 `GenerationTestCase`）~~

✅ **已解决**：`new_test_service.py` 和 `new_test_management.py` 已合并到主文件中，系统已统一。

## 清理方案

### 阶段1：标记废弃（过渡期）

1. **在 `test_service.py` 中标记废弃方法**
   ```python
   # 在以下方法上添加 @deprecated 装饰器或注释
   - create_test_case()  # 已废弃，请使用 RetrieverTestCaseService 或 GenerationTestCaseService
   - get_test_case()
   - list_test_cases()
   - update_test_case()
   - delete_test_case()
   ```

2. **在 `test_management.py` 中标记废弃端点**
   ```python
   # 在以下路由上添加废弃标记
   - POST /tests/test-cases
   - GET /tests/test-cases
   - GET /tests/test-cases/{id}
   - PUT /tests/test-cases/{id}
   - DELETE /tests/test-cases/{id}
   ```

### 阶段2：前端迁移

1. **删除或迁移 `test-case-management.tsx`**
   - 该组件使用旧的 `testAPI.createTestCase` 等API
   - 应该使用 `retrieverTestCaseAPI` 或 `generationTestCaseAPI` 替代

2. **更新 `api.ts`**
   - 标记 `testAPI` 中的测试用例相关方法为废弃
   - 或直接删除这些方法

### 阶段3：后端清理（最终）

1. **从 `test_service.py` 删除以下方法**
   - `create_test_case()`
   - `get_test_case()`
   - `list_test_cases()`
   - `update_test_case()`
   - `delete_test_case()`
   - 删除 `self.test_case_repo` 的初始化

2. **从 `test_management.py` 删除以下路由**
   - `/tests/test-cases` 的所有CRUD端点

3. **清理模型和Schema**
   - `TestCase` 模型已标记废弃，可考虑完全删除
   - `TestCaseCreate`, `TestCaseUpdate`, `TestCaseResponse` Schema

4. **清理Repository**
   - 检查 `create_test_case_repository()` 是否还有其他地方使用
   - 如果没有，可以删除相关代码

## 保留的功能

以下功能应该保留，因为它们仍在使用：

### test_service.py 保留的方法：
- ✅ `create_test_set()` - 测试集管理
- ✅ `get_test_set()`
- ✅ `list_test_sets()`
- ✅ `update_test_set()`
- ✅ `delete_test_set()`
- ✅ `run_retrieval_test()` - 虽然未实现，但接口保留
- ✅ `run_generation_test()` - 虽然未实现，但接口保留

### test_management.py 保留的路由：
- ✅ `/tests/test-sets` - 测试集CRUD
- ✅ `/tests/test-sets/{id}/import-preview` - 导入预览
- ✅ `/tests/test-sets/{id}/import-to-kb` - 导入到知识库
- ✅ `/tests/test-sets/{id}/import-history` - 导入历史
- ✅ `/tests/import-tasks/{id}` - 导入任务详情
- ✅ `/tests/knowledge-bases/{kb_id}/test-sets` - 知识库测试集列表

## 迁移检查清单

- [ ] 检查是否有其他服务依赖旧的 `TestCase` API
- [ ] 检查数据库迁移脚本是否需要更新
- [ ] 检查评估任务服务是否依赖旧的 `TestCase`
- [ ] 更新API文档，移除废弃端点
- [ ] 更新前端类型定义，移除废弃接口
- [ ] 运行测试确保没有破坏性变更

## 注意事项

1. **数据迁移**：如果有现有数据使用 `TestCase` 模型，需要先迁移到新模型
2. **向后兼容**：如果对外提供API，需要考虑版本兼容性
3. **测试覆盖**：确保新系统的测试用例覆盖完整

