# RAGé“¾è·¯è°ƒè¯•ç³»ç»Ÿ - æ¶æ„è®¾è®¡

## ç³»ç»Ÿæ¦‚è¿°

æä¾›å¯è§†åŒ–çš„RAGå…¨é“¾è·¯è°ƒè¯•å·¥å…·ï¼Œè®©æ¯ä¸ªæ­¥éª¤éƒ½èƒ½ç‹¬ç«‹æµ‹è¯•ã€é¢„è§ˆå’ŒéªŒè¯ã€‚

---

## æ ¸å¿ƒåŠŸèƒ½æ¨¡å—

### 1. æ–‡æ¡£å¤„ç† (Document Processing)

**åŠŸèƒ½:**
- ğŸ“¤ ä¸Šä¼ æ–‡æ¡£ï¼ˆTXT, PDF, DOCX, MDç­‰ï¼‰
- ğŸ“„ è§£ææ–‡æ¡£å†…å®¹
- âœ‚ï¸ æ–‡æ¡£åˆ†å—ï¼ˆChunkingï¼‰
- ğŸ‘ï¸ é¢„è§ˆåˆ†å—ç»“æœ

**APIè®¾è®¡:**
```
POST /api/v1/debug/document/upload          # ä¸Šä¼ æ–‡æ¡£
POST /api/v1/debug/document/parse           # è§£ææ–‡æ¡£
POST /api/v1/debug/document/chunk           # åˆ†å—
GET  /api/v1/debug/document/{id}/chunks     # æŸ¥çœ‹åˆ†å—åˆ—è¡¨
```

**æ•°æ®æµ:**
```
åŸå§‹æ–‡ä»¶ â†’ è§£æ â†’ çº¯æ–‡æœ¬ â†’ åˆ†å— â†’ åˆ†å—åˆ—è¡¨
```

---

### 2. æ–‡æ¡£åµŒå…¥ (Document Embedding)

**åŠŸèƒ½:**
- ğŸ”¢ å¯¹åˆ†å—åˆ—è¡¨è¿›è¡Œå‘é‡åŒ–
- ğŸ“Š æ˜¾ç¤ºembeddingç»´åº¦å’Œç»Ÿè®¡ä¿¡æ¯
- ğŸ‘ï¸ é¢„è§ˆembeddingç»“æœï¼ˆå‰å‡ ç»´ï¼‰
- âš™ï¸ æ”¯æŒä¸åŒembeddingæ¨¡å‹

**APIè®¾è®¡:**
```
POST /api/v1/debug/embedding/embed          # æ‰¹é‡embedding
GET  /api/v1/debug/embedding/preview        # é¢„è§ˆembedding
GET  /api/v1/debug/embedding/models         # è·å–å¯ç”¨æ¨¡å‹åˆ—è¡¨
```

**æ•°æ®æµ:**
```
åˆ†å—åˆ—è¡¨ â†’ EmbeddingæœåŠ¡ â†’ å‘é‡åˆ—è¡¨ (dimension: 768/1024/...)
```

---

### 3. æ–‡æ¡£åˆ†è¯ (Text Tokenization)

**åŠŸèƒ½:**
- âœ‚ï¸ ä½¿ç”¨jiebaè¿›è¡Œä¸­æ–‡åˆ†è¯
- ğŸ”¤ æ˜¾ç¤ºåˆ†è¯ç»“æœ
- ğŸ“Š ç»Ÿè®¡è¯é¢‘
- ğŸš« æ”¯æŒåœç”¨è¯è¿‡æ»¤

**APIè®¾è®¡:**
```
POST /api/v1/debug/tokenize/jieba           # jiebaåˆ†è¯
POST /api/v1/debug/tokenize/batch           # æ‰¹é‡åˆ†è¯
GET  /api/v1/debug/tokenize/preview         # é¢„è§ˆåˆ†è¯ç»“æœ
```

**æ•°æ®æµ:**
```
åˆ†å—æ–‡æœ¬ â†’ jiebaåˆ†è¯ â†’ è¯åˆ—è¡¨ â†’ è¿‡æ»¤åœç”¨è¯ â†’ æœ€ç»ˆè¯åˆ—è¡¨
```

---

### 4. ç´¢å¼•å†™å…¥ (Index Writing)

**åŠŸèƒ½:**
- ğŸ’¾ å†™å…¥å‘é‡æ•°æ®åº“ï¼ˆChromaDB, Milvusç­‰ï¼‰
- ğŸ’¾ å†™å…¥åˆ†è¯ç´¢å¼•ï¼ˆElasticSearch/è‡ªå®ç°ï¼‰
- ğŸ“Š æ˜¾ç¤ºå†™å…¥è¿›åº¦å’Œç»Ÿè®¡
- âœ… éªŒè¯ç´¢å¼•æ˜¯å¦æˆåŠŸ

**APIè®¾è®¡:**
```
POST /api/v1/debug/index/vector/write       # å†™å…¥å‘é‡ç´¢å¼•
POST /api/v1/debug/index/keyword/write      # å†™å…¥åˆ†è¯ç´¢å¼•
GET  /api/v1/debug/index/stats              # ç´¢å¼•ç»Ÿè®¡ä¿¡æ¯
POST /api/v1/debug/index/verify             # éªŒè¯ç´¢å¼•
```

**æ•°æ®æµ:**
```
å‘é‡æ•°æ® â†’ å‘é‡DB
åˆ†è¯æ•°æ® â†’ å€’æ’ç´¢å¼•
```

---

### 5. æ£€ç´¢è°ƒè¯• (Retrieval Debug)

**åŠŸèƒ½:**
- ğŸ” å‘é‡æ£€ç´¢ï¼ˆVector Searchï¼‰
- ğŸ” å…³é”®è¯æ£€ç´¢ï¼ˆKeyword Searchï¼‰
- ğŸ” æ··åˆæ£€ç´¢ï¼ˆHybrid Searchï¼‰
- ğŸ¯ RRF Rerankç®—æ³•
- âš™ï¸ å¯è°ƒå‚æ•°ï¼ˆtop_k, alpha, weightsç­‰ï¼‰
- ğŸ“Š æ˜¾ç¤ºæ£€ç´¢ç»“æœå’Œè¯„åˆ†

**APIè®¾è®¡:**
```
POST /api/v1/debug/retrieve/vector          # å‘é‡æ£€ç´¢
POST /api/v1/debug/retrieve/keyword         # å…³é”®è¯æ£€ç´¢
POST /api/v1/debug/retrieve/hybrid          # æ··åˆæ£€ç´¢
POST /api/v1/debug/retrieve/rerank          # RRFé‡æ’åº
```

**æ•°æ®æµ:**
```
æŸ¥è¯¢æ–‡æœ¬ â†’ [å‘é‡æ£€ç´¢] â†’ ç»“æœA (with scores)
         â†’ [å…³é”®è¯æ£€ç´¢] â†’ ç»“æœB (with scores)
         â†’ [æ··åˆ] â†’ RRFé‡æ’ â†’ æœ€ç»ˆç»“æœ
```

---

### 6. ç”Ÿæˆè°ƒè¯• (Generation Debug)

**çŠ¶æ€:** æš‚ä¸å®ç°

---

## å‰ç«¯UIè®¾è®¡

### é¡µé¢ç»“æ„

```
é“¾è·¯è°ƒè¯•é¡µé¢
â”œâ”€ æ­¥éª¤å¯¼èˆªï¼ˆé¡¶éƒ¨ï¼‰
â”‚  â”œâ”€ 1. æ–‡æ¡£å¤„ç† âœ…
â”‚  â”œâ”€ 2. æ–‡æ¡£åµŒå…¥ â¸ï¸
â”‚  â”œâ”€ 3. æ–‡æ¡£åˆ†è¯ â¸ï¸
â”‚  â”œâ”€ 4. ç´¢å¼•å†™å…¥ â¸ï¸
â”‚  â””â”€ 5. æ£€ç´¢è°ƒè¯• â¸ï¸
â”‚
â””â”€ æ­¥éª¤å†…å®¹åŒº
   â”œâ”€ æ“ä½œé¢æ¿ï¼ˆå·¦ä¾§/é¡¶éƒ¨ï¼‰
   â”‚  â”œâ”€ è¾“å…¥å‚æ•°
   â”‚  â”œâ”€ é…ç½®é€‰é¡¹
   â”‚  â””â”€ æ‰§è¡ŒæŒ‰é’®
   â”‚
   â””â”€ ç»“æœå±•ç¤ºï¼ˆå³ä¾§/åº•éƒ¨ï¼‰
      â”œâ”€ æ‰§è¡Œç»“æœ
      â”œâ”€ æ•°æ®é¢„è§ˆ
      â””â”€ ç»Ÿè®¡ä¿¡æ¯
```

### æ­¥éª¤1: æ–‡æ¡£å¤„ç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“„ æ–‡æ¡£å¤„ç†                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [ä¸Šä¼ æ–‡ä»¶] é€‰æ‹©æ–‡ä»¶...              â”‚
â”‚                                     â”‚
â”‚ æ–‡æ¡£ä¿¡æ¯:                           â”‚
â”‚ - æ–‡ä»¶å: example.txt               â”‚
â”‚ - å¤§å°: 10KB                        â”‚
â”‚ - ç±»å‹: TXT                         â”‚
â”‚                                     â”‚
â”‚ [è§£ææ–‡æ¡£] [åˆ†å—è®¾ç½®]               â”‚
â”‚ - Chunk Size: 500                   â”‚
â”‚ - Chunk Overlap: 50                 â”‚
â”‚                                     â”‚
â”‚ åˆ†å—ç»“æœ: (å…±15ä¸ªåˆ†å—)              â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Chunk 1:                       â”‚ â”‚
â”‚ â”‚ "è¿™æ˜¯ç¬¬ä¸€ä¸ªåˆ†å—çš„å†…å®¹..."      â”‚ â”‚
â”‚ â”‚ å­—æ•°: 485 | Tokens: ~620       â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ Chunk 2:                       â”‚ â”‚
â”‚ â”‚ "è¿™æ˜¯ç¬¬äºŒä¸ªåˆ†å—çš„å†…å®¹..."      â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ [å¯¼å‡ºåˆ†å—JSON] [ä¸‹ä¸€æ­¥: åµŒå…¥] â†’    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤2: æ–‡æ¡£åµŒå…¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ”¢ æ–‡æ¡£åµŒå…¥                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Embeddingæ¨¡å‹:                      â”‚
â”‚ [v] bge-m3:latest (1024ç»´)          â”‚
â”‚ [ ] text-embedding-ada-002          â”‚
â”‚                                     â”‚
â”‚ è¾“å…¥: 15ä¸ªåˆ†å—                      â”‚
â”‚                                     â”‚
â”‚ [å¼€å§‹åµŒå…¥]                          â”‚
â”‚                                     â”‚
â”‚ è¿›åº¦: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (15/15)    â”‚
â”‚                                     â”‚
â”‚ åµŒå…¥ç»“æœé¢„è§ˆ:                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Chunk 1:                       â”‚ â”‚
â”‚ â”‚ Vector (å‰5ç»´):                â”‚ â”‚
â”‚ â”‚ [0.234, -0.156, 0.891, ...]    â”‚ â”‚
â”‚ â”‚ Norm: 1.0                      â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ ç»Ÿè®¡ä¿¡æ¯:                      â”‚ â”‚
â”‚ â”‚ - æ€»åˆ†å—æ•°: 15                 â”‚ â”‚
â”‚ â”‚ - å‘é‡ç»´åº¦: 1024               â”‚ â”‚
â”‚ â”‚ - å¹³å‡è€—æ—¶: 120ms/chunk        â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ [å¯¼å‡ºå‘é‡JSON] [ä¸‹ä¸€æ­¥: åˆ†è¯] â†’    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤3: æ–‡æ¡£åˆ†è¯

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âœ‚ï¸ æ–‡æ¡£åˆ†è¯                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ åˆ†è¯å·¥å…·: jieba                     â”‚
â”‚ [v] ä½¿ç”¨åœç”¨è¯è¡¨                    â”‚
â”‚                                     â”‚
â”‚ [å¼€å§‹åˆ†è¯]                          â”‚
â”‚                                     â”‚
â”‚ åˆ†è¯ç»“æœé¢„è§ˆ:                       â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Chunk 1:                       â”‚ â”‚
â”‚ â”‚ åŸæ–‡: "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„..." â”‚ â”‚
â”‚ â”‚ åˆ†è¯: [æœºå™¨å­¦ä¹ , æ˜¯, äººå·¥æ™ºèƒ½] â”‚ â”‚
â”‚ â”‚ è¿‡æ»¤å: [æœºå™¨å­¦ä¹ , äººå·¥æ™ºèƒ½]   â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ è¯é¢‘ç»Ÿè®¡ (Top 10):             â”‚ â”‚
â”‚ â”‚ 1. æœºå™¨å­¦ä¹ : 15æ¬¡              â”‚ â”‚
â”‚ â”‚ 2. äººå·¥æ™ºèƒ½: 12æ¬¡              â”‚ â”‚
â”‚ â”‚ 3. æ·±åº¦å­¦ä¹ : 8æ¬¡               â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ [å¯¼å‡ºåˆ†è¯JSON] [ä¸‹ä¸€æ­¥: ç´¢å¼•] â†’    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤4: ç´¢å¼•å†™å…¥

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ’¾ ç´¢å¼•å†™å…¥                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç›®æ ‡çŸ¥è¯†åº“: kb_demo                 â”‚
â”‚                                     â”‚
â”‚ ç´¢å¼•ç±»å‹:                           â”‚
â”‚ [v] å‘é‡ç´¢å¼• (ChromaDB)             â”‚
â”‚ [v] å…³é”®è¯ç´¢å¼• (å†…ç½®)               â”‚
â”‚                                     â”‚
â”‚ [å†™å…¥ç´¢å¼•]                          â”‚
â”‚                                     â”‚
â”‚ å‘é‡ç´¢å¼•: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100% (15/15)    â”‚
â”‚ âœ… å†™å…¥æˆåŠŸ: 15ä¸ªå‘é‡               â”‚
â”‚                                     â”‚
â”‚ å…³é”®è¯ç´¢å¼•: â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ 100%          â”‚
â”‚ âœ… å†™å…¥æˆåŠŸ: 125ä¸ªå”¯ä¸€è¯            â”‚
â”‚                                     â”‚
â”‚ [éªŒè¯ç´¢å¼•]                          â”‚
â”‚ âœ… å‘é‡ç´¢å¼•éªŒè¯é€šè¿‡                 â”‚
â”‚ âœ… å…³é”®è¯ç´¢å¼•éªŒè¯é€šè¿‡               â”‚
â”‚                                     â”‚
â”‚ [ä¸‹ä¸€æ­¥: æ£€ç´¢æµ‹è¯•] â†’                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ­¥éª¤5: æ£€ç´¢è°ƒè¯•

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ” æ£€ç´¢è°ƒè¯•                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æŸ¥è¯¢: [æœºå™¨å­¦ä¹ çš„åº”ç”¨åœºæ™¯_______]   â”‚
â”‚                                     â”‚
â”‚ æ£€ç´¢æ¨¡å¼:                           â”‚
â”‚ ( ) å‘é‡æ£€ç´¢                        â”‚
â”‚ ( ) å…³é”®è¯æ£€ç´¢                      â”‚
â”‚ (â€¢) æ··åˆæ£€ç´¢                        â”‚
â”‚                                     â”‚
â”‚ å‚æ•°é…ç½®:                           â”‚
â”‚ - Top K: [10]                       â”‚
â”‚ - Vector Weight: [0.7]              â”‚
â”‚ - Keyword Weight: [0.3]             â”‚
â”‚ - RRF k: [60]                       â”‚
â”‚                                     â”‚
â”‚ [æ‰§è¡Œæ£€ç´¢]                          â”‚
â”‚                                     â”‚
â”‚ æ£€ç´¢ç»“æœ:                           â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ å‘é‡æ£€ç´¢ (10ä¸ªç»“æœ):           â”‚ â”‚
â”‚ â”‚ 1. Chunk_5: 0.89               â”‚ â”‚
â”‚ â”‚ 2. Chunk_3: 0.85               â”‚ â”‚
â”‚ â”‚ ...                            â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ å…³é”®è¯æ£€ç´¢ (10ä¸ªç»“æœ):         â”‚ â”‚
â”‚ â”‚ 1. Chunk_3: 0.92               â”‚ â”‚
â”‚ â”‚ 2. Chunk_7: 0.88               â”‚ â”‚
â”‚ â”‚ ...                            â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚ RRFèåˆå (Top 5):             â”‚ â”‚
â”‚ â”‚ 1. Chunk_3: 0.91 â­            â”‚ â”‚
â”‚ â”‚    å†…å®¹: "æœºå™¨å­¦ä¹ åœ¨å›¾åƒè¯†åˆ«..."â”‚ â”‚
â”‚ â”‚ 2. Chunk_5: 0.87               â”‚ â”‚
â”‚ â”‚    å†…å®¹: "æœºå™¨å­¦ä¹ çš„å…¸å‹åº”ç”¨..."â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                     â”‚
â”‚ [å¯¼å‡ºç»“æœ] [è°ƒæ•´å‚æ•°é‡è¯•]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## åç«¯å®ç°æ¶æ„

### æ–°å¢æœåŠ¡

```python
# app/services/document_processor.py
class DocumentProcessor:
    """æ–‡æ¡£å¤„ç†æœåŠ¡"""
    async def parse_document(file) -> str
    async def chunk_document(text, chunk_size, overlap) -> List[Chunk]
    
# app/services/tokenizer_service.py
class TokenizerService:
    """åˆ†è¯æœåŠ¡"""
    async def jieba_tokenize(text) -> List[str]
    async def batch_tokenize(chunks) -> List[List[str]]
    
# app/services/index_service.py
class IndexService:
    """ç´¢å¼•æœåŠ¡"""
    async def write_vector_index(kb_id, chunks_with_vectors)
    async def write_keyword_index(kb_id, chunks_with_tokens)
    async def verify_index(kb_id) -> dict
    
# app/services/retrieval_service.py
class RetrievalService:
    """æ£€ç´¢æœåŠ¡"""
    async def vector_search(kb_id, query, top_k) -> List[Result]
    async def keyword_search(kb_id, query, top_k) -> List[Result]
    async def hybrid_search(kb_id, query, config) -> List[Result]
    async def rrf_rerank(results_list) -> List[Result]
```

### æ–°å¢Controller

```python
# app/controllers/debug_pipeline.py
router = APIRouter(prefix="/debug", tags=["é“¾è·¯è°ƒè¯•"])

@router.post("/document/upload")
@router.post("/document/parse")
@router.post("/document/chunk")
@router.post("/embedding/embed")
@router.post("/tokenize/jieba")
@router.post("/index/write")
@router.post("/retrieve/hybrid")
```

---

## æ•°æ®æ¨¡å‹

### DebugSession (è°ƒè¯•ä¼šè¯)

```python
class DebugSession(BaseModel):
    """è°ƒè¯•ä¼šè¯ - ä¿å­˜æ•´ä¸ªè°ƒè¯•è¿‡ç¨‹çš„æ•°æ®"""
    id: str
    name: str
    kb_id: str
    
    # æ­¥éª¤1: æ–‡æ¡£å¤„ç†
    document_id: Optional[str]
    chunks: Optional[List[Chunk]]
    
    # æ­¥éª¤2: åµŒå…¥
    embeddings: Optional[List[Vector]]
    
    # æ­¥éª¤3: åˆ†è¯
    tokens: Optional[List[List[str]]]
    
    # æ­¥éª¤4: ç´¢å¼•
    indexed: bool = False
    
    # å…ƒæ•°æ®
    config: dict
    created_at: datetime
```

---

## RRFç®—æ³•å®ç°

### Reciprocal Rank Fusion (RRF)

```python
def rrf_score(rank: int, k: int = 60) -> float:
    """
    è®¡ç®—RRFåˆ†æ•°
    rank: æ–‡æ¡£åœ¨æ’åºåˆ—è¡¨ä¸­çš„ä½ç½®ï¼ˆä»1å¼€å§‹ï¼‰
    k: å¸¸æ•°ï¼Œé€šå¸¸ä¸º60
    """
    return 1.0 / (k + rank)

def rrf_fusion(
    results_lists: List[List[Tuple[doc_id, score]]],
    k: int = 60
) -> List[Tuple[doc_id, float]]:
    """
    èåˆå¤šä¸ªæ£€ç´¢ç»“æœåˆ—è¡¨
    """
    doc_scores = defaultdict(float)
    
    for results in results_lists:
        for rank, (doc_id, _) in enumerate(results, start=1):
            doc_scores[doc_id] += rrf_score(rank, k)
    
    # æŒ‰RRFåˆ†æ•°æ’åº
    return sorted(doc_scores.items(), key=lambda x: x[1], reverse=True)
```

---

## å®æ–½è®¡åˆ’

### Phase 1: æ–‡æ¡£å¤„ç† (1-2å¤©)
- [x] æ–‡æ¡£ä¸Šä¼ å’Œè§£æ
- [ ] æ–‡æ¡£åˆ†å—é€»è¾‘
- [ ] åˆ†å—é¢„è§ˆAPI
- [ ] å‰ç«¯æ–‡æ¡£å¤„ç†UI

### Phase 2: åµŒå…¥å’Œåˆ†è¯ (1-2å¤©)
- [ ] EmbeddingæœåŠ¡é›†æˆ
- [ ] Jiebaåˆ†è¯é›†æˆ
- [ ] æ‰¹é‡å¤„ç†æ¥å£
- [ ] å‰ç«¯é¢„è§ˆUI

### Phase 3: ç´¢å¼•å†™å…¥ (1å¤©)
- [ ] å‘é‡ç´¢å¼•å†™å…¥
- [ ] å…³é”®è¯ç´¢å¼•å†™å…¥
- [ ] ç´¢å¼•éªŒè¯
- [ ] å‰ç«¯ç´¢å¼•UI

### Phase 4: æ£€ç´¢è°ƒè¯• (2-3å¤©)
- [ ] å‘é‡æ£€ç´¢
- [ ] å…³é”®è¯æ£€ç´¢
- [ ] RRFèåˆç®—æ³•
- [ ] å‰ç«¯æ£€ç´¢UI
- [ ] å‚æ•°è°ƒä¼˜ç•Œé¢

### Phase 5: é›†æˆæµ‹è¯• (1å¤©)
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] æ€§èƒ½ä¼˜åŒ–
- [ ] æ–‡æ¡£å®Œå–„

---

## æŠ€æœ¯æ ˆ

### åç«¯
- FastAPI
- jieba (ä¸­æ–‡åˆ†è¯)
- sentence-transformers / ollama (embedding)
- ChromaDB / Milvus (å‘é‡æ•°æ®åº“)
- numpy (å‘é‡è®¡ç®—)

### å‰ç«¯
- React / Next.js
- TypeScript
- Tailwind CSS
- Recharts (å¯è§†åŒ–)

---

## å…³é”®ç‰¹æ€§

1. **æ­¥éª¤åŒ–è°ƒè¯•** - æ¯æ­¥ç‹¬ç«‹ï¼Œå¯é‡å¤æ‰§è¡Œ
2. **å¯è§†åŒ–é¢„è§ˆ** - ç›´è§‚çœ‹åˆ°æ¯æ­¥çš„è¾“å‡º
3. **å‚æ•°å¯è°ƒ** - å®æ—¶è°ƒæ•´å‚æ•°çœ‹æ•ˆæœ
4. **æ•°æ®å¯¼å‡º** - æ¯æ­¥ç»“æœå¯å¯¼å‡ºJSON
5. **ä¼šè¯ä¿å­˜** - è°ƒè¯•ä¼šè¯å¯ä¿å­˜æ¢å¤

---

**åˆ›å»ºæ—¶é—´:** 2025-11-07  
**çŠ¶æ€:** è®¾è®¡å®Œæˆï¼Œå¾…å®æ–½

