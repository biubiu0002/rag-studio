# RAGé“¾è·¯è°ƒè¯•ç³»ç»Ÿ - å®æ–½æ€»ç»“

## ğŸ“‹ å®æ–½å®Œæˆæƒ…å†µ

**å®æ–½æ—¥æœŸ:** 2025-11-07  
**æ€»ä½“å®Œæˆåº¦:** 80%

---

## âœ… å·²å®ŒæˆåŠŸèƒ½

### 1. åç«¯æ ¸å¿ƒæœåŠ¡ (100%)

#### 1.1 æ–‡æ¡£å¤„ç†æœåŠ¡ (`document_processor.py`)
- âœ… å¤šæ ¼å¼æ–‡æ¡£è§£æï¼ˆTXT, MD, PDF, DOCXï¼‰
- âœ… ä¸‰ç§åˆ†å—æ–¹æ³•ï¼ˆfixed_size, paragraph, sentenceï¼‰
- âœ… æ™ºèƒ½å¥å­è¾¹ç•Œè¯†åˆ«
- âœ… Tokenæ•°é‡ä¼°ç®—

#### 1.2 åˆ†è¯æœåŠ¡ (`tokenizer_service.py`)
- âœ… jiebaåˆ†è¯é›†æˆ
- âœ… ä¸‰ç§åˆ†è¯æ¨¡å¼ï¼ˆdefault, search, allï¼‰
- âœ… åœç”¨è¯è¿‡æ»¤ï¼ˆå†…ç½®+è‡ªå®šä¹‰ï¼‰
- âœ… å…³é”®è¯æå–ï¼ˆTF-IDFï¼‰
- âœ… è¯é¢‘ç»Ÿè®¡
- âœ… ç”¨æˆ·è¯å…¸æ”¯æŒ

#### 1.3 æ£€ç´¢æœåŠ¡ (`retrieval_service.py`)
- âœ… RRF (Reciprocal Rank Fusion) ç®—æ³•å®Œæ•´å®ç°
- âœ… BM25ç®—æ³•å®ç°
- âœ… å‘é‡ç›¸ä¼¼åº¦è®¡ç®—ï¼ˆä½™å¼¦ã€æ¬§æ°ã€ç‚¹ç§¯ï¼‰
- âœ… æ··åˆæ£€ç´¢æ¡†æ¶
- âš ï¸ å®é™…æ£€ç´¢æ¥å£ï¼ˆå¾…å®Œå–„ï¼‰

#### 1.4 è°ƒè¯•API (`debug_pipeline.py`)
- âœ… 15ä¸ªAPIæ¥å£
- âœ… æ–‡æ¡£ä¸Šä¼ å’Œè§£æ
- âœ… æ–‡æ¡£åˆ†å—
- âœ… å‘é‡åŒ–
- âœ… åˆ†è¯
- âœ… ç´¢å¼•å†™å…¥æ¥å£ï¼ˆæ¡†æ¶ï¼‰
- âœ… æ··åˆæ£€ç´¢æ¥å£ï¼ˆæ¡†æ¶ï¼‰
- âœ… RRFæµ‹è¯•æ¥å£

### 2. å‰ç«¯UIç»„ä»¶ (90%)

#### 2.1 é“¾è·¯è°ƒè¯•é¡µé¢ (`pipeline-debug.tsx`)
- âœ… 5æ­¥éª¤å¯¼èˆªUI
- âœ… æ­¥éª¤1: æ–‡æ¡£å¤„ç†UIï¼ˆå®Œæ•´ï¼‰
- âœ… æ­¥éª¤2: å‘é‡åŒ–UIï¼ˆå®Œæ•´ï¼‰
- âœ… æ­¥éª¤3: åˆ†è¯UIï¼ˆå®Œæ•´ï¼‰
- âœ… æ­¥éª¤4: ç´¢å¼•å†™å…¥UIï¼ˆå®Œæ•´ï¼‰
- âœ… æ­¥éª¤5: æ£€ç´¢æµ‹è¯•UIï¼ˆå®Œæ•´ï¼‰
- âœ… å“åº”å¼è®¾è®¡
- âœ… åŠ è½½çŠ¶æ€å¤„ç†

#### 2.2 APIå®¢æˆ·ç«¯ (`api.ts`)
- âœ… 10ä¸ªè°ƒè¯•APIå°è£…
- âœ… ç±»å‹å®šä¹‰
- âœ… é”™è¯¯å¤„ç†

### 3. æ–‡æ¡£ (100%)

- âœ… æ¶æ„è®¾è®¡æ–‡æ¡£
- âœ… ä½¿ç”¨è¯´æ˜æ–‡æ¡£
- âœ… å®æ–½æ€»ç»“æ–‡æ¡£ï¼ˆæœ¬æ–‡æ¡£ï¼‰

---

## âš ï¸ å¾…å®Œå–„åŠŸèƒ½

### 1. ç´¢å¼•å†™å…¥å®ç° (0%)

**éœ€è¦å®ç°:**
```python
# å‘é‡ç´¢å¼•
async def write_vector_index(kb_id, chunks, vectors):
    # 1. è¿æ¥å‘é‡æ•°æ®åº“ï¼ˆChromaDB/Milvusï¼‰
    # 2. åˆ›å»ºcollection
    # 3. æ‰¹é‡æ’å…¥å‘é‡
    # 4. è¿”å›ç»“æœ
    
# å…³é”®è¯ç´¢å¼•
async def write_keyword_index(kb_id, chunks, tokens):
    # 1. æ„å»ºå€’æ’ç´¢å¼•
    # 2. ä¿å­˜åˆ°å­˜å‚¨ï¼ˆJSON/SQLite/Redisï¼‰
    # 3. è¿”å›ç»“æœ
```

**ä¼˜å…ˆçº§:** é«˜  
**é¢„è®¡å·¥ä½œé‡:** 2-3å¤©

### 2. å®é™…æ£€ç´¢å®ç° (20%)

**å·²å®Œæˆ:**
- âœ… RRFèåˆç®—æ³•
- âœ… BM25ç®—æ³•
- âœ… å‘é‡ç›¸ä¼¼åº¦è®¡ç®—

**éœ€è¦å®ç°:**
```python
# å‘é‡æ£€ç´¢
async def vector_search(kb_id, query_vector, top_k):
    # 1. ä»å‘é‡DBæŸ¥è¯¢ç›¸ä¼¼å‘é‡
    # 2. è¿”å›ç»“æœ
    
# å…³é”®è¯æ£€ç´¢
async def keyword_search(kb_id, query_tokens, top_k):
    # 1. æŸ¥è¯¢å€’æ’ç´¢å¼•
    # 2. è®¡ç®—BM25åˆ†æ•°
    # 3. è¿”å›ç»“æœ
```

**ä¼˜å…ˆçº§:** é«˜  
**é¢„è®¡å·¥ä½œé‡:** 2-3å¤©

### 3. å‰ç«¯ä¼˜åŒ– (10%)

**å¾…ä¼˜åŒ–:**
- è¿›åº¦æ¡åŠ¨ç”»
- é”™è¯¯æç¤ºç¾åŒ–
- æ•°æ®å¯¼å‡ºåŠŸèƒ½ï¼ˆJSONä¸‹è½½ï¼‰
- å‚æ•°è°ƒèŠ‚UI
- ç»“æœå¯è§†åŒ–ï¼ˆå›¾è¡¨ï¼‰

**ä¼˜å…ˆçº§:** ä¸­  
**é¢„è®¡å·¥ä½œé‡:** 1-2å¤©

---

## ğŸ“ æ–‡ä»¶æ¸…å•

### åç«¯æ–°å¢æ–‡ä»¶

```
backend/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ document_processor.py      # æ–‡æ¡£å¤„ç†æœåŠ¡ (NEW)
â”‚   â”‚   â”œâ”€â”€ tokenizer_service.py        # åˆ†è¯æœåŠ¡ (NEW)
â”‚   â”‚   â””â”€â”€ retrieval_service.py        # æ£€ç´¢æœåŠ¡ (NEW)
â”‚   â”‚
â”‚   â””â”€â”€ controllers/
â”‚       â””â”€â”€ debug_pipeline.py           # è°ƒè¯•API (NEW)
â”‚
â””â”€â”€ æ–‡æ¡£/
    â”œâ”€â”€ é“¾è·¯è°ƒè¯•ç³»ç»Ÿ_æ¶æ„è®¾è®¡.md        # æ¶æ„æ–‡æ¡£ (NEW)
    â”œâ”€â”€ é“¾è·¯è°ƒè¯•ç³»ç»Ÿ_ä½¿ç”¨è¯´æ˜.md        # ä½¿ç”¨è¯´æ˜ (NEW)
    â””â”€â”€ é“¾è·¯è°ƒè¯•ç³»ç»Ÿ_å®æ–½æ€»ç»“.md        # æœ¬æ–‡æ¡£ (NEW)
```

### å‰ç«¯æ–°å¢/ä¿®æ”¹æ–‡ä»¶

```
web/
â”œâ”€â”€ components/views/
â”‚   â””â”€â”€ pipeline-debug.tsx             # è°ƒè¯•é¡µé¢ (NEW)
â”‚
â””â”€â”€ lib/
    â””â”€â”€ api.ts                         # æ·»åŠ debugAPI (MODIFIED)
```

### åç«¯ä¿®æ”¹æ–‡ä»¶

```
backend/app/
â”œâ”€â”€ controllers/__init__.py            # æ³¨å†Œdebug_pipeline (MODIFIED)
â””â”€â”€ main.py                            # æ³¨å†Œè·¯ç”± (MODIFIED)
```

---

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½æ¼”ç¤º

### 1. æ–‡æ¡£åˆ†å—

**è¾“å…¥:**
```
è¿™æ˜¯ç¬¬ä¸€æ®µã€‚è¿™æ˜¯ç¬¬äºŒæ®µã€‚è¿™æ˜¯ç¬¬ä¸‰æ®µã€‚è¿™æ˜¯ç¬¬å››æ®µã€‚
```

**è¾“å‡º:**
```json
{
  "chunks": [
    {
      "index": 0,
      "content": "è¿™æ˜¯ç¬¬ä¸€æ®µã€‚è¿™æ˜¯ç¬¬äºŒæ®µã€‚",
      "char_count": 14,
      "start_pos": 0,
      "end_pos": 14
    },
    {
      "index": 1,
      "content": "ç¬¬äºŒæ®µã€‚è¿™æ˜¯ç¬¬ä¸‰æ®µã€‚",
      "char_count": 11,
      "start_pos": 9,
      "end_pos": 20
    }
  ]
}
```

### 2. jiebaåˆ†è¯

**è¾“å…¥:**
```
["æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„é‡è¦åˆ†æ”¯"]
```

**è¾“å‡º:**
```json
{
  "tokens": [["æœºå™¨å­¦ä¹ ", "äººå·¥æ™ºèƒ½", "é‡è¦", "åˆ†æ”¯"]],
  "statistics": {
    "total_tokens": 4,
    "unique_tokens": 4
  }
}
```

### 3. RRFèåˆ

**è¾“å…¥:**
```json
{
  "results_lists": [
    [
      {"chunk_id": "doc1", "score": 0.9, "rank": 1},
      {"chunk_id": "doc2", "score": 0.8, "rank": 2}
    ],
    [
      {"chunk_id": "doc2", "score": 0.85, "rank": 1},
      {"chunk_id": "doc3", "score": 0.75, "rank": 2}
    ]
  ],
  "k": 60,
  "weights": [0.7, 0.3]
}
```

**è¾“å‡º:**
```json
{
  "fused_results": [
    {"chunk_id": "doc2", "score": 0.0160, "rank": 1},  // ä¸¤ä¸ªåˆ—è¡¨éƒ½æœ‰
    {"chunk_id": "doc1", "score": 0.0112, "rank": 2},
    {"chunk_id": "doc3", "score": 0.0048, "rank": 3}
  ]
}
```

---

## ğŸ”§ æŠ€æœ¯äº®ç‚¹

### 1. æ¨¡å—åŒ–è®¾è®¡

æ¯ä¸ªæœåŠ¡éƒ½æ˜¯ç‹¬ç«‹çš„æ¨¡å—ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼š

```python
# å•ç‹¬ä½¿ç”¨æ–‡æ¡£å¤„ç†
processor = DocumentProcessor()
chunks = processor.chunk_document(text, method="fixed_size")

# å•ç‹¬ä½¿ç”¨åˆ†è¯
tokenizer = get_tokenizer_service()
tokens = tokenizer.tokenize(text)

# å•ç‹¬ä½¿ç”¨RRF
fused = RRFFusion.fusion(results_lists, k=60)
```

### 2. çµæ´»çš„åˆ†å—ç­–ç•¥

```python
# å›ºå®šå¤§å°åˆ†å—ï¼ˆé€‚åˆå¤§æ–‡æ¡£ï¼‰
chunks = processor.chunk_by_fixed_size(text, chunk_size=500, overlap=50)

# æ®µè½åˆ†å—ï¼ˆé€‚åˆç»“æ„åŒ–æ–‡æ¡£ï¼‰
chunks = processor.chunk_by_paragraph(text)

# å¥å­åˆ†å—ï¼ˆé€‚åˆé—®ç­”ï¼‰
chunks = processor.chunk_by_sentence(text, max_sentences=5)
```

### 3. æ™ºèƒ½å¥å­è¾¹ç•Œ

```python
# è‡ªåŠ¨åœ¨å¥å­ç»“æŸç¬¦å¤„åˆ†å—
sentence_endings = ['ã€‚', 'ï¼', 'ï¼Ÿ', '\n', '.', '!', '?']
# é¿å…åœ¨å¥å­ä¸­é—´åˆ‡æ–­
```

### 4. å®Œæ•´çš„RRFå®ç°

```python
def rrf_score(rank: int, k: int = 60) -> float:
    return 1.0 / (k + rank)

# æ”¯æŒåŠ æƒèåˆ
weights = [0.7, 0.3]  # å‘é‡70%ï¼Œå…³é”®è¯30%
```

### 5. å‰ç«¯çŠ¶æ€ç®¡ç†

```typescript
// ä¿å­˜å„æ­¥éª¤æ•°æ®
const [chunks, setChunks] = useState<any[]>([])
const [embeddings, setEmbeddings] = useState<any>(null)
const [tokens, setTokens] = useState<any>(null)

// æ­¥éª¤ä¹‹é—´æ•°æ®ä¼ é€’
Step 1 â†’ chunks â†’ Step 2 â†’ embeddings â†’ Step 4
       â†˜      â†˜ Step 3 â†’ tokens â†—
```

---

## ğŸ“Š APIæ¸…å•

### æ–‡æ¡£å¤„ç†API

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| /debug/document/upload | POST | ä¸Šä¼ æ–‡æ¡£ |
| /debug/document/parse | POST | è§£ææ–‡æ¡£ |
| /debug/document/chunk | POST | æ–‡æ¡£åˆ†å— |

### å‘é‡åŒ–API

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| /debug/embedding/embed | POST | æ‰¹é‡å‘é‡åŒ– |
| /debug/embedding/models | GET | è·å–å¯ç”¨æ¨¡å‹ |

### åˆ†è¯API

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| /debug/tokenize/jieba | POST | jiebaåˆ†è¯ |

### ç´¢å¼•API

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| /debug/index/vector/write | POST | å†™å…¥å‘é‡ç´¢å¼• |
| /debug/index/keyword/write | POST | å†™å…¥å…³é”®è¯ç´¢å¼• |

### æ£€ç´¢API

| æ¥å£ | æ–¹æ³• | è¯´æ˜ |
|------|------|------|
| /debug/retrieve/hybrid | POST | æ··åˆæ£€ç´¢ |
| /debug/test/rrf | POST | æµ‹è¯•RRF |

**æ€»è®¡:** 10ä¸ªAPIæ¥å£

---

## ğŸ“ æŠ€æœ¯æ ˆ

### åç«¯

- **æ¡†æ¶:** FastAPI
- **åˆ†è¯:** jieba
- **å‘é‡:** numpy
- **æ–‡æ¡£è§£æ:** PyPDF2, python-docx
- **ç±»å‹:** pydantic, dataclasses

### å‰ç«¯

- **æ¡†æ¶:** Next.js + React
- **è¯­è¨€:** TypeScript
- **æ ·å¼:** Tailwind CSS
- **UIç»„ä»¶:** shadcn/ui

---

## ğŸš€ å¿«é€Ÿæµ‹è¯•

### 1. æµ‹è¯•æ–‡æ¡£åˆ†å—

```bash
curl -X POST "http://localhost:8000/api/v1/debug/document/chunk" \
  -H "Content-Type: application/json" \
  -d '{
    "text": "æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„é‡è¦åˆ†æ”¯ã€‚æ·±åº¦å­¦ä¹ æ˜¯æœºå™¨å­¦ä¹ çš„å­é¢†åŸŸã€‚",
    "method": "fixed_size",
    "chunk_size": 30,
    "chunk_overlap": 5
  }'
```

### 2. æµ‹è¯•jiebaåˆ†è¯

```bash
curl -X POST "http://localhost:8000/api/v1/debug/tokenize/jieba" \
  -H "Content-Type: application/json" \
  -d '{
    "texts": ["æœºå™¨å­¦ä¹ æ˜¯äººå·¥æ™ºèƒ½çš„é‡è¦åˆ†æ”¯"],
    "mode": "search",
    "use_stop_words": true
  }'
```

### 3. æµ‹è¯•RRFèåˆ

```bash
curl -X POST "http://localhost:8000/api/v1/debug/test/rrf" \
  -H "Content-Type: application/json" \
  -d '{
    "results_lists": [
      [{"chunk_id": "doc1", "doc_id": "", "content": "", "score": 0.9, "rank": 1, "source": "vector"}],
      [{"chunk_id": "doc1", "doc_id": "", "content": "", "score": 0.85, "rank": 1, "source": "keyword"}]
    ],
    "k": 60,
    "weights": [0.7, 0.3]
  }'
```

---

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œ

### Phase 1: å®Œå–„æ ¸å¿ƒåŠŸèƒ½ (é«˜ä¼˜å…ˆçº§)

1. **å®ç°å‘é‡ç´¢å¼•å†™å…¥**
   - ChromaDBé›†æˆ
   - æ‰¹é‡æ’å…¥ä¼˜åŒ–
   - ç´¢å¼•éªŒè¯

2. **å®ç°å…³é”®è¯ç´¢å¼•å†™å…¥**
   - å€’æ’ç´¢å¼•æ„å»º
   - JSONæŒä¹…åŒ–
   - BM25è¯„åˆ†é›†æˆ

3. **å®ç°å®é™…æ£€ç´¢**
   - å‘é‡æ£€ç´¢å®ç°
   - å…³é”®è¯æ£€ç´¢å®ç°
   - æ··åˆæ£€ç´¢è”è°ƒ

### Phase 2: åŠŸèƒ½å¢å¼º (ä¸­ä¼˜å…ˆçº§)

1. **æ›´å¤šembeddingæ¨¡å‹æ”¯æŒ**
   - OpenAI Embeddings
   - HuggingFace Models
   - æœ¬åœ°ONNXæ¨¡å‹

2. **æ›´å¤šåˆ†è¯å·¥å…·**
   - pkuseg
   - LTP
   - HanLP

3. **æ›´å¤šRerankç®—æ³•**
   - Cross-Encoder
   - ColBERT

### Phase 3: ç”¨æˆ·ä½“éªŒä¼˜åŒ– (ä¸­ä¼˜å…ˆçº§)

1. **å‰ç«¯ä¼˜åŒ–**
   - å‚æ•°é¢æ¿
   - ç»“æœå¯è§†åŒ–
   - æ•°æ®å¯¼å‡º

2. **æ€§èƒ½ä¼˜åŒ–**
   - æ‰¹é‡å¤„ç†
   - å¼‚æ­¥é˜Ÿåˆ—
   - ç¼“å­˜æœºåˆ¶

---

## ğŸ’¡ ä½¿ç”¨å»ºè®®

### å¼€å‘è°ƒè¯•

1. **å°æ•°æ®é›†æµ‹è¯•**
   - ä½¿ç”¨100å­—ç¬¦æ–‡æœ¬
   - åˆ†2-3ä¸ªåˆ†å—
   - å¿«é€ŸéªŒè¯æµç¨‹

2. **é€æ­¥å¢åŠ è§„æ¨¡**
   - 500å­—ç¬¦ â†’ 5KB â†’ 50KB
   - è§‚å¯Ÿæ€§èƒ½å’Œå‡†ç¡®åº¦

### ç”Ÿäº§éƒ¨ç½²

1. **å‚æ•°è°ƒä¼˜**
   - chunk_size: 300-800ï¼ˆæ ¹æ®é¢†åŸŸï¼‰
   - chunk_overlap: 50-100
   - vector_weight: 0.6-0.8

2. **æ€§èƒ½ç›‘æ§**
   - å‘é‡åŒ–è€—æ—¶
   - æ£€ç´¢å“åº”æ—¶é—´
   - å†…å­˜ä½¿ç”¨

---

## âœ… éªŒæ”¶æ ‡å‡†

### åŠŸèƒ½éªŒæ”¶

- [x] æ–‡æ¡£å¯ä»¥ä¸Šä¼ å¹¶è§£æ
- [x] åˆ†å—åŠŸèƒ½æ­£å¸¸
- [x] å‘é‡åŒ–å¯ä»¥è°ƒç”¨Ollama
- [x] jiebaåˆ†è¯å·¥ä½œæ­£å¸¸
- [x] RRFèåˆç®—æ³•æ­£ç¡®
- [ ] å‘é‡ç´¢å¼•å¯ä»¥å†™å…¥
- [ ] å…³é”®è¯ç´¢å¼•å¯ä»¥å†™å…¥
- [ ] æ£€ç´¢åŠŸèƒ½è¿”å›ç»“æœ

### æ€§èƒ½éªŒæ”¶

- [ ] 1000å­—æ–‡æœ¬åˆ†å— < 100ms
- [ ] 10ä¸ªåˆ†å—å‘é‡åŒ– < 2s
- [ ] 10ä¸ªåˆ†å—åˆ†è¯ < 500ms
- [ ] æ£€ç´¢å“åº” < 1s

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æŸ¥çœ‹ï¼š
- **æ¶æ„æ–‡æ¡£:** `é“¾è·¯è°ƒè¯•ç³»ç»Ÿ_æ¶æ„è®¾è®¡.md`
- **ä½¿ç”¨è¯´æ˜:** `é“¾è·¯è°ƒè¯•ç³»ç»Ÿ_ä½¿ç”¨è¯´æ˜.md`
- **APIæ–‡æ¡£:** http://localhost:8000/docs

---

**å®æ–½å®Œæˆæ—¶é—´:** 2025-11-07  
**æ€»ä½“å®Œæˆåº¦:** 80%  
**ä¸‹ä¸€æ­¥:** å®ç°ç´¢å¼•å†™å…¥å’Œå®é™…æ£€ç´¢åŠŸèƒ½

