# 测试集管理交互重构

## 概述

重构测试集管理功能，实现测试集与知识库的多对多关系。测试集独立维护，可以导入到多个知识库。评估任务在知识库内创建和管理。

## 业务流程

1. **维护测试集**：独立创建和管理测试集，不绑定知识库
2. **导入到知识库**：将测试集导入到目标知识库（支持导入到多个知识库）
3. **知识库内评估**：在知识库内，基于已导入的测试集，调整检索参数，创建评估任务

## 实体关系设计

### 核心实体

- **TestSet（测试集）**：独立存在，不绑定知识库
    - 字段：id, name, description, test_type, case_count, created_at, updated_at
    - 移除：kb_id（不再直接关联知识库）

- **KnowledgeBase（知识库）**：独立存在

- **TestSetKnowledgeBase（关联表）**：记录测试集导入到知识库的关系
    - 字段：id, test_set_id, kb_id, imported_at, import_config（导入时的配置快照）
    - 唯一约束：(test_set_id, kb_id) - 同一测试集不能重复导入到同一知识库

- **EvaluationTask（评估任务）**：属于某个知识库，使用某个测试集
    - 字段：id, test_set_id, kb_id, evaluation_type, task_name, status, retrieval_config, generation_config
    - 约束：创建评估任务时，需要验证测试集已导入到该知识库

## 主要变更

### 1. 后端修改

#### 1.1 数据库模型修改

- **文件**: `backend/app/database/models.py`
- **变更**: 
    - 移除 `TestSetORM.kb_id` 字段（或改为可空用于兼容）
    - 新增关联表 `TestSetKnowledgeBaseORM`：
    ```python
    class TestSetKnowledgeBaseORM(Base):
        __tablename__ = "test_set_knowledge_bases"
        id = Column(String(50), primary_key=True)
        test_set_id = Column(String(50), ForeignKey("test_sets.id", ondelete="CASCADE"), nullable=False, index=True)
        kb_id = Column(String(50), ForeignKey("knowledge_bases.id", ondelete="CASCADE"), nullable=False, index=True)
        imported_at = Column(DateTime, nullable=False, server_default=func.now())
        import_config = Column(JSON, nullable=True)  # 存储导入时的配置快照
        created_at = Column(DateTime, nullable=False, server_default=func.now())
        # 唯一约束：同一测试集不能重复导入到同一知识库
        __table_args__ = (UniqueConstraint('test_set_id', 'kb_id', name='uq_test_set_kb'),)
    ```

- **影响**: 需要数据库迁移脚本（清空旧数据，使用新结构）

#### 1.2 数据模型修改

- **文件**: `backend/app/models/test.py`
- **变更**: 
    - 移除 `TestSet.kb_id` 字段（或改为 `Optional[str]` 用于兼容）
    - 新增 `TestSetKnowledgeBase` 模型：
    ```python
    class TestSetKnowledgeBase(BaseModelMixin):
        test_set_id: str
        kb_id: str
        imported_at: datetime
        import_config: Dict[str, Any] = Field(default_factory=dict)
    ```


#### 1.3 Schema修改

- **文件**: `backend/app/schemas/test.py`
- **变更**: 
    - `TestSetCreate.kb_id` 改为 `Optional[str]`（创建时不需要）
    - 新增 `ImportTestSetToKnowledgeBaseRequest` schema：
    ```python
    class ImportTestSetToKnowledgeBaseRequest(BaseModel):
        kb_id: str = Field(..., description="目标知识库ID")
        deduplication_strategy: str = Field("content_hash", description="去重策略: content_hash/external_id/none")
        update_existing: bool = Field(True, description="是否更新已存在的文档")
    ```


#### 1.4 服务层修改

- **文件**: `backend/app/services/test_service.py`
- **变更**:
    - `create_test_set` 方法：移除 `kb_id` 必填验证，移除从知识库获取配置的逻辑
    - 新增 `import_test_set_to_kb` 方法：
        - 提取测试用例中的所有答案文本（检索用例的expected_answers）
        - 根据去重策略检查知识库中是否已存在（基于content_hash或external_id）
        - 批量导入新文档到知识库
        - 更新测试集的 `kb_id` 和配置快照
        - 返回导入统计（新增、更新、跳过数量）

#### 1.5 文档服务增强

- **文件**: `backend/app/services/document.py`
- **变更**:
    - 增强 `batch_create_documents_from_dict` 方法，支持去重检查
    - 新增 `check_document_exists` 方法：基于content_hash或external_id检查文档是否存在
    - 新增 `get_document_by_content_hash` 方法：根据内容hash查找文档

#### 1.6 控制器修改

- **文件**: `backend/app/controllers/test_management.py` 或 `new_test_management.py`
- **变更**:
    - 创建测试集接口：移除 `kb_id` 必填验证
    - 新增导入接口：`POST /test-sets/{test_set_id}/import-to-kb`
    - 新增导入预览接口：`GET /test-sets/{test_set_id}/import-preview?kb_id=xxx`（预览将导入的文档）

### 2. 前端修改

#### 2.1 菜单结构优化

- **文件**: `web/components/sidebar.tsx`
- **变更**: 
    - 简化测试管理菜单结构：
    ```
    测试管理
 - 测试集（test-set-management）
 - 评估任务（evaluation-tasks）
    ```

    - 移除旧的子菜单项：检索器用例、生成用例、旧版用例管理、检索器评估、生成器评估、评估历史

#### 2.2 测试集管理界面重构

- **文件**: `web/components/views/test-set-management.tsx`
- **功能**:
    - **列表视图**（默认）：
        - 显示所有测试集列表（支持按类型筛选：检索/生成）
        - 显示测试集名称、类型、用例数量、创建时间
        - 操作按钮：新建测试集、导入测试集（待实现）、查看详情
        - 点击测试集进入详情视图
    - **详情视图**（选中测试集后）：
        - 顶部：测试集基本信息（名称、描述、类型、用例数量）
        - 左侧sidebar（宽度w-48）：
            - "返回列表" 按钮
            - 菜单项：
                - 检索器用例（test_type为retrieval时显示）
                - 生成用例（test_type为generation时显示）
                - 导入历史（显示该测试集的导入记录）
        - 右侧内容区域：
            - 根据选中的菜单项显示对应内容
            - 检索器用例：复用 `retriever-test-case-management.tsx` 的逻辑（移除左侧测试集列表）
            - 生成用例：复用 `generation-test-case-management.tsx` 的逻辑
            - 导入历史：
                - 显示该测试集导入到各个知识库的记录
                - 每条记录显示：知识库名称、导入时间、导入状态、导入进度（如果进行中）
                - 支持"导入到知识库"按钮（打开导入对话框）
    - **创建测试集对话框**：
        - 字段：名称、描述、测试类型（检索/生成）
        - 移除知识库选择字段
    - **导入到知识库对话框**：
        - 步骤1：选择目标知识库
        - 步骤2：配置导入参数（去重策略、是否更新已存在文档）
        - 步骤3：预览导入结果（将导入的文档数量、去重统计）
        - 步骤4：执行导入（显示进度条、实时更新）
        - 步骤5：显示导入结果（新增、更新、跳过数量）

#### 2.3 检索器用例界面调整

- **文件**: `web/components/views/retriever-test-case-management.tsx`
- **变更**: 
    - 改为接收 `test_set_id` 作为props（从父组件传入）
    - 移除左侧测试集列表sidebar
    - 保留右侧用例管理功能（创建、编辑、删除用例）

#### 2.4 生成用例界面调整

- **文件**: `web/components/views/generation-test-case-management.tsx`
- **变更**: 
    - 改为接收 `test_set_id` 作为props（从父组件传入）
    - 移除左侧测试集列表sidebar
    - 保留右侧用例管理功能

#### 2.5 评估任务管理界面（新建）

- **文件**: `web/components/views/evaluation-tasks.tsx`（新建）
- **功能**:
    - **列表视图**：
        - 显示所有评估任务列表
        - 支持按知识库筛选（下拉选择）
        - 支持按状态筛选（运行中、已完成、失败异常）
        - 显示任务信息：任务名称、测试集名称、知识库名称、评估类型、状态、进度、创建时间
        - 运行中的任务：显示进度条和实时更新
        - 操作：查看详情、删除（已完成/失败的任务）
    - **创建评估任务流程**（两步）：
        - **步骤1：确认检索配置**
            - 显示知识库的当前检索配置
            - 允许用户修改配置参数：
                - top_k、score_threshold
                - 融合策略（RRF等）
                - 向量权重、关键词权重
                - 嵌入模型、稀疏向量方法
            - 选择测试集（仅显示已导入到该知识库的测试集）
            - 选择评估类型（检索/生成）
        - **步骤2：查看/编辑用例**
            - 显示选中测试集的所有用例列表
            - 支持查看用例详情（问题、期望答案等）
            - 支持新增用例（临时添加到本次评估任务）
            - 支持编辑用例（仅影响本次评估任务，不修改测试集）
            - 支持选择要评估的用例（全选/部分选择）
            - 确认后创建评估任务
    - **任务详情视图**：
        - 显示任务基本信息（配置、状态、进度）
        - 显示评估结果（指标、汇总）
        - 显示用例结果列表（可查看每个用例的详细结果）
        - 支持重新执行任务（使用相同配置）

#### 2.6 导入历史组件（新建）

- **文件**: `web/components/views/test-set-import-history.tsx`（新建）
- **功能**:
    - 显示测试集的导入历史记录
    - 每条记录显示：
        - 知识库名称（可点击跳转）
        - 导入时间
        - 导入状态（成功/进行中/失败）
        - 导入进度（如果进行中）
        - 导入统计（新增、更新、跳过文档数量）
    - 支持查看导入详情
    - 支持"导入到知识库"按钮

#### 2.7 API接口更新

- **文件**: `web/lib/api.ts`
- **变更**:
    - `createTestSet`: `kb_id` 改为可选
    - 新增 `importTestSetToKnowledgeBase`: 导入测试集到知识库
    - 新增 `previewTestSetImport`: 预览导入结果
    - 新增 `getTestSetImportHistory`: 获取测试集的导入历史
    - 新增 `getImportProgress`: 获取导入进度（如果异步导入）
    - `listEvaluationTasks`: 支持按知识库和状态筛选
    - 新增 `getKnowledgeBaseTestSets`: 获取知识库已导入的测试集列表

### 3. 数据库迁移

#### 3.1 创建迁移脚本

- **文件**: `backend/migrations/003_make_test_set_kb_id_nullable.py`
- **内容**: 
    - 将 `test_sets.kb_id` 字段改为可空
    - 清空现有测试集数据（根据用户要求，不需要保留旧数据）

## 实施步骤

1. **后端基础修改**

      - 修改Schema和模型（使kb_id可选）
      - 创建数据库迁移脚本
      - 修改服务层（移除kb_id必填验证，移除从知识库获取配置的逻辑）

2. **导入功能实现**

      - 实现文档去重检查逻辑（content_hash）
      - 实现导入服务方法（提取答案、去重、批量导入）
      - 实现导入预览接口
      - 实现导入接口

3. **前端界面重构**

      - 重构测试集管理界面（列表+详情布局）
      - 调整检索器用例界面（作为子组件）
      - 创建评估任务管理组件
      - 实现导入到知识库功能

4. **API和集成**

      - 更新前端API定义
      - 测试前后端集成

5. **测试验证**

      - 测试创建测试集（不绑定知识库）
      - 测试导入到知识库功能（去重、预览）
      - 测试评估任务管理

## 技术细节

### 去重策略

1. **external_id**：

      - 如果测试用例的答案有external_id，使用该ID检查
      - 优点：快速
      - 缺点：需要测试用例提供external_id

### 导入流程

1. 用户选择目标知识库和去重策略
2. 系统预览：提取所有答案文本，检查重复情况
3. 用户确认后执行导入：

      - 批量创建新文档
      - 更新已存在的文档（如果选择update_existing）
      - 更新测试集的kb_id和配置快照

4. 返回导入统计结果

## 已确认的需求

### 1. 测试集管理相关

1.1 **测试集的可见性和权限**

   - ✅ 当前无需考虑权限和可见性控制

1.2 **测试集的版本管理**

   - ✅ 测试集修改后，无需同步更新已导入的知识库
   - ✅ 已创建的评估任务不受影响，按创建时的快照为准
   - ✅ 测试集可以维护版本历史（需要实现版本记录功能）

1.3 **测试集的删除和归档**

   - ✅ 删除测试集时，如果有关联（已导入到知识库），禁止删除，提示先解除关联

### 2. 导入到知识库相关

2.1 **导入时的文档处理**

   - ✅ 每个答案文本创建一个独立文档，独立chunk
   - ✅ 测试集管理中使用 `external_id` 概念（而非chunk_id）
   - ✅ 导入时，如果答案中有external_id，保留作为文档的external_id

2.2 **去重和同步机制**

   - ✅ 去重策略：基于external_id检查文档是否存在
   - ✅ 更新已存在的文档：基于external_id更新文档内容、元数据、更新时间戳
   - ✅ 测试集被修改后，知识库不需要同步，保持导入时的快照

2.3 **导入配置快照**

   - ✅ `import_config` 保存知识库的完整配置（vector_db_type, embedding_model等）
   - ✅ 配置快照用于：评估任务时的配置参考、审计和追溯

2.4 **导入性能和大数据量处理**

   - ✅ 异步任务导入，后台执行，显示进度
   - ✅ 导入失败时，保留已导入的文档，记录失败信息

### 3. 评估任务相关

3.1 **评估任务的创建和验证**

   - ✅ 验证测试集已导入到知识库：检查 TestSetKnowledgeBase 关联表
   - ✅ 如果测试集未导入到知识库，允许创建评估任务，用户可以后续编辑问题和答案

3.2 **评估任务的配置**

   - ✅ 检索配置来源：使用导入时的配置快照（import_config），同时用户可以手动配置
   - ✅ 配置修改：未执行前可以修改

3.3 **评估任务的查看和管理**

   - ✅ 评估任务列表展示位置：在"评估任务"菜单的页面中展示
   - ✅ 评估任务删除：只能归档，不能删除

## 已确认的补充需求

### 1. 测试集版本历史

- ✅ 简单实现即可，不重要

### 2. 导入任务和进度

2.1 **导入任务的存储和查询**

   - ✅ 创建 ImportTask 表，记录导入任务状态和进度
   - ✅ 导入进度：前端轮询查询导入进度
   - ✅ 失败信息：记录在 ImportTask 表的 error_message 字段

2.2 **导入任务的重新执行**

   - ✅ 导入失败处理：简单处理即可
   - ✅ 导入成功后支持重新导入（覆盖）：基于external_id更新文档
   - ✅ **重要**：每个答案文本需要分配一个唯一的external_id

### 3. 评估任务创建流程

3.1 **创建评估任务时的知识库选择**

   - ✅ 必须先选择知识库，然后显示该知识库已导入的测试集
   - ✅ 如果测试集未导入到知识库：提供导入测试集的快捷入口

3.2 **评估任务中的用例编辑**

   - ✅ 新增/编辑用例的作用范围：仅影响本次评估任务，不修改测试集
   - ✅ 用例编辑不保存到测试集，仅用于本次评估

### 4. 评估任务归档

4.1 **归档的实现方式**

   - ✅ 使用 `status` 枚举值（添加 ARCHIVED 状态）
   - ✅ 归档后的评估任务：在列表中显示，但标记为已归档，默认按时间倒序排序
   - ✅ 归档后的评估任务：不可以恢复（永久归档）

### 5. 数据一致性和错误处理

5.1 **关联删除的处理**

   - ✅ 知识库被删除：保留 TestSetKnowledgeBase 记录，标记知识库已删除
   - ✅ 测试集被删除：保留 TestSetKnowledgeBase 记录，标记测试集已删除
   - ✅ test_set_id 和 kb_id：不需要外键约束，允许软删除

5.2 **错误处理和边界情况**

   - ✅ 导入时知识库/测试集不存在：直接报错"xxx不存在"
   - ✅ 创建评估任务时测试集未导入：弹窗提示，提供导入测试集的快捷入口
   - ✅ 任务执行时知识库配置变化：按任务创建时的配置副本执行

### 6. 界面交互细节

6.1 **测试集列表**

   - ✅ 需要分页
   - ✅ 按时间倒序排序
   - ✅ 不显示关联的知识库数量

6.2 **导入历史界面**

   - ✅ 需要分页
   - ✅ 需要显示导入统计（新增、更新、跳过数量）
   - ✅ 不需要查看导入详情（文档列表）

6.3 **评估任务列表**

   - ✅ 需要分页
   - ✅ 按时间倒序排序
   - ✅ 运行中的任务自动刷新进度

## 实施要点补充

### 重要变更

1. **答案文本的external_id生成**

   - 每个答案文本需要分配唯一的external_id
   - 格式建议：`test_set_{test_set_id}_case_{case_id}_answer_{answer_index}`
   - 或使用UUID：`answer_{uuid}`

2. **ImportTask表设计**
   ```python
   class ImportTaskORM(Base):
       __tablename__ = "import_tasks"
       id = Column(String(50), primary_key=True)
       test_set_id = Column(String(50), ForeignKey("test_sets.id"), nullable=False, index=True)
       kb_id = Column(String(50), nullable=False, index=True)
       status = Column(String(20), nullable=False, default="pending")  # pending/running/completed/failed
       progress = Column(Float, default=0.0)  # 0.0-1.0
       total_docs = Column(Integer, default=0)
       imported_docs = Column(Integer, default=0)
       failed_docs = Column(Integer, default=0)
       error_message = Column(Text, nullable=True)
       import_config = Column(JSON, nullable=True)
       started_at = Column(DateTime, nullable=True)
       completed_at = Column(DateTime, nullable=True)
       created_at = Column(DateTime, nullable=False, server_default=func.now())
   ```

3. **EvaluationStatus枚举扩展**

   - 添加 `ARCHIVED = "archived"` 状态

4. **软删除标记**

   - TestSetKnowledgeBase 添加 `kb_deleted` 和 `test_set_deleted` 布尔字段

### 

## 注意事项

- 数据库迁移会清空现有测试集数据
- 导入功能需要处理大量文档，考虑性能优化（批量处理、异步任务）
- 去重检查可能需要优化（建立索引、缓存）
- 评估任务创建时需要检查测试集是否已关联知识库
- 需要明确以上需求问题后再进行详细设计和实现