# ä¸­é—´ä»¶ä¸é…ç½®ç®¡ç†

<cite>
**æœ¬æ–‡æ¡£ä¸­å¼•ç”¨çš„æ–‡ä»¶**
- [middleware.py](file://backend/app/core/middleware.py)
- [config.py](file://backend/app/config.py)
- [main.py](file://backend/app/main.py)
- [exceptions.py](file://backend/app/core/exceptions.py)
- [vector_db_service.py](file://backend/app/services/vector_db_service.py)
</cite>

## ç›®å½•
1. [ç®€ä»‹](#ç®€ä»‹)
2. [é¡¹ç›®ç»“æ„æ¦‚è§ˆ](#é¡¹ç›®ç»“æ„æ¦‚è§ˆ)
3. [ä¸­é—´ä»¶ç³»ç»Ÿ](#ä¸­é—´ä»¶ç³»ç»Ÿ)
4. [é…ç½®ç®¡ç†ç³»ç»Ÿ](#é…ç½®ç®¡ç†ç³»ç»Ÿ)
5. [å‘é‡æ•°æ®åº“è¿æ¥é…ç½®](#å‘é‡æ•°æ®åº“è¿æ¥é…ç½®)
6. [å®‰å…¨é…ç½®ä¸æœ€ä½³å®è·µ](#å®‰å…¨é…ç½®ä¸æœ€ä½³å®è·µ)
7. [æ€§èƒ½è°ƒä¼˜æŒ‡å—](#æ€§èƒ½è°ƒä¼˜æŒ‡å—)
8. [æ•…éšœæ’é™¤æŒ‡å—](#æ•…éšœæ’é™¤æŒ‡å—)
9. [æ€»ç»“](#æ€»ç»“)

## ç®€ä»‹

RAG-Studioé‡‡ç”¨ç°ä»£åŒ–çš„FastAPIæ¡†æ¶æ„å»ºï¼Œå…·å¤‡å®Œå–„çš„ä¸­é—´ä»¶ä¸é…ç½®ç®¡ç†ä½“ç³»ã€‚è¯¥ç³»ç»Ÿé€šè¿‡RequestIDMiddlewareå’ŒTimingMiddlewareæä¾›å…¨é“¾è·¯è¿½è¸ªå’Œæ€§èƒ½ç›‘æ§èƒ½åŠ›ï¼ŒåŒæ—¶åŸºäºPydantic Settingsçš„é…ç½®ç®¡ç†æœºåˆ¶ç¡®ä¿åº”ç”¨çš„çµæ´»æ€§å’Œå®‰å…¨æ€§ã€‚æœ¬æ–‡æ¡£å°†æ·±å…¥è§£æè¿™äº›æ ¸å¿ƒç»„ä»¶çš„å®ç°åŸç†å’Œæœ€ä½³å®è·µã€‚

## é¡¹ç›®ç»“æ„æ¦‚è§ˆ

RAG-Studioçš„ä¸­é—´ä»¶ä¸é…ç½®ç®¡ç†æ¨¡å—ä¸»è¦åˆ†å¸ƒåœ¨ä»¥ä¸‹å…³é”®æ–‡ä»¶ä¸­ï¼š

```mermaid
graph TB
subgraph "æ ¸å¿ƒæ¨¡å—"
A[main.py] --> B[config.py]
A --> C[middleware.py]
A --> D[exceptions.py]
end
subgraph "æœåŠ¡å±‚"
E[vector_db_service.py] --> F[Qdranté…ç½®]
E --> G[Elasticsearché…ç½®]
E --> H[Milvusé…ç½®]
end
subgraph "é…ç½®ç®¡ç†"
B --> I[Settingsç±»]
B --> J[ç¯å¢ƒå˜é‡åŠ è½½]
B --> K[åŠ¨æ€å±æ€§è®¡ç®—]
end
A --> E
C --> L[RequestIDMiddleware]
C --> M[TimingMiddleware]
C --> N[setup_middlewares]
```

**å›¾è¡¨æ¥æº**
- [main.py](file://backend/app/main.py#L1-L112)
- [config.py](file://backend/app/config.py#L1-L99)
- [middleware.py](file://backend/app/core/middleware.py#L1-L62)

**ç« èŠ‚æ¥æº**
- [main.py](file://backend/app/main.py#L1-L112)
- [config.py](file://backend/app/config.py#L1-L99)

## ä¸­é—´ä»¶ç³»ç»Ÿ

### RequestIDMiddleware - å…¨é“¾è·¯è¿½è¸ªæ ¸å¿ƒ

RequestIDMiddlewareæ˜¯RAG-Studioå®ç°å…¨é“¾è·¯è¿½è¸ªçš„å…³é”®ç»„ä»¶ï¼Œä¸ºæ¯ä¸ªHTTPè¯·æ±‚ç”Ÿæˆå”¯ä¸€æ ‡è¯†ç¬¦ï¼Œå¹¶å°†å…¶æ³¨å…¥åˆ°å“åº”å¤´ä¸­ã€‚

#### æ ¸å¿ƒå®ç°åŸç†

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯
participant Middleware as RequestIDMiddleware
participant App as FastAPIåº”ç”¨
participant Response as å“åº”å¯¹è±¡
Client->>Middleware : HTTPè¯·æ±‚
Middleware->>Middleware : ç”ŸæˆUUIDè¯·æ±‚ID
Middleware->>App : è®¾ç½®request.state.request_id
Middleware->>App : è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶/è·¯ç”±
App-->>Middleware : å¤„ç†ç»“æœ
Middleware->>Response : æ³¨å…¥X-Request-IDå¤´
Middleware-->>Client : è¿”å›å“åº”
```

**å›¾è¡¨æ¥æº**
- [middleware.py](file://backend/app/core/middleware.py#L18-L24)

#### æŠ€æœ¯ç‰¹æ€§

1. **å”¯ä¸€æ€§ä¿è¯**: ä½¿ç”¨UUID v4ç®—æ³•ç¡®ä¿è¯·æ±‚IDçš„å…¨å±€å”¯ä¸€æ€§
2. **çŠ¶æ€ä¼ é€’**: é€šè¿‡`request.state`åœ¨è¯·æ±‚ç”Ÿå‘½å‘¨æœŸå†…ä¿æŒè¯·æ±‚ID
3. **å“åº”æ³¨å…¥**: è‡ªåŠ¨å°†è¯·æ±‚IDæ·»åŠ åˆ°HTTPå“åº”å¤´ä¸­
4. **é€æ˜æ€§**: å¯¹ä¸šåŠ¡é€»è¾‘æ— ä¾µå…¥ï¼Œè‡ªåŠ¨å¤„ç†æ‰€æœ‰è¯·æ±‚

### TimingMiddleware - æ€§èƒ½ç›‘æ§å¼•æ“

TimingMiddlewareè´Ÿè´£è®°å½•æ¯ä¸ªè¯·æ±‚çš„å¤„ç†æ—¶é—´ï¼Œæä¾›å®æ—¶çš„æ€§èƒ½ç›‘æ§èƒ½åŠ›ã€‚

#### å®ç°æœºåˆ¶

```mermaid
flowchart TD
A[æ¥æ”¶è¯·æ±‚] --> B[è®°å½•å¼€å§‹æ—¶é—´]
B --> C[è°ƒç”¨ä¸‹ä¸€ä¸ªä¸­é—´ä»¶]
C --> D[è®°å½•ç»“æŸæ—¶é—´]
D --> E[è®¡ç®—å¤„ç†æ—¶é—´]
E --> F[æ³¨å…¥X-Process-Timeå¤´]
F --> G[æ‰“å°æ—¥å¿—ä¿¡æ¯]
G --> H[è¿”å›å“åº”]
style A fill:#e1f5fe
style H fill:#e8f5e8
style G fill:#fff3e0
```

**å›¾è¡¨æ¥æº**
- [middleware.py](file://backend/app/core/middleware.py#L34-L49)

#### æ—¥å¿—è¾“å‡ºæ ¼å¼

TimingMiddlewareé‡‡ç”¨ç»“æ„åŒ–çš„æ—¥å¿—è¾“å‡ºæ ¼å¼ï¼Œä¾¿äºç›‘æ§å’Œåˆ†æï¼š

```
ğŸ“ [è¯·æ±‚ID] METHOD PATH - STATUS_CODE - PROCESS_TIME.s
```

ç¤ºä¾‹è¾“å‡ºï¼š
```
ğŸ“ [123e4567-e89b-12d3-a456-426614174000] GET /api/v1/health - 200 - 0.015s
```

### ä¸­é—´ä»¶æ³¨å†Œæœºåˆ¶

setup_middlewareså‡½æ•°è´Ÿè´£å°†è‡ªå®šä¹‰ä¸­é—´ä»¶æ³¨å†Œåˆ°FastAPIåº”ç”¨å®ä¾‹ä¸­ï¼š

```mermaid
classDiagram
class setup_middlewares {
+app : FastAPI
+add_middleware(RequestIDMiddleware)
+add_middleware(TimingMiddleware)
}
class FastAPI {
+add_middleware(middleware)
+lifespan : Lifespan
}
setup_middlewares --> FastAPI : æ³¨å†Œä¸­é—´ä»¶
```

**å›¾è¡¨æ¥æº**
- [middleware.py](file://backend/app/core/middleware.py#L52-L61)
- [main.py](file://backend/app/main.py#L59-L60)

**ç« èŠ‚æ¥æº**
- [middleware.py](file://backend/app/core/middleware.py#L1-L62)
- [main.py](file://backend/app/main.py#L59-L60)

## é…ç½®ç®¡ç†ç³»ç»Ÿ

### Pydantic Settingsæ¶æ„

RAG-Studioé‡‡ç”¨Pydantic Settingsä½œä¸ºé…ç½®ç®¡ç†çš„æ ¸å¿ƒï¼Œæä¾›ç±»å‹å®‰å…¨ã€ç¯å¢ƒå˜é‡é©±åŠ¨çš„é…ç½®ä½“ç³»ã€‚

#### é…ç½®ç±»è®¾è®¡

```mermaid
classDiagram
class Settings {
+APP_NAME : str
+APP_VERSION : str
+DEBUG : bool
+API_PREFIX : str
+HOST : str
+PORT : int
+ALLOWED_ORIGINS : str
+DB_HOST : str
+DB_PORT : int
+DB_USER : str
+DB_PASSWORD : str
+DB_NAME : str
+STORAGE_TYPE : str
+STORAGE_PATH : str
+OLLAMA_BASE_URL : str
+OLLAMA_EMBEDDING_MODEL : str
+OLLAMA_CHAT_MODEL : str
+VECTOR_DB_TYPE : str
+ES_HOST : str
+ES_PORT : int
+ES_USER : str
+ES_PASSWORD : str
+QDRANT_HOST : str
+QDRANT_PORT : int
+QDRANT_API_KEY : str
+MILVUS_HOST : str
+MILVUS_PORT : int
+MILVUS_USER : str
+MILVUS_PASSWORD : str
+allowed_origins_list() List[str]
+database_url() str
+elasticsearch_url() str
+Config : EnvFileConfig
}
class BaseSettings {
<<abstract>>
+Config : SettingsConfigDict
}
Settings --|> BaseSettings
```

**å›¾è¡¨æ¥æº**
- [config.py](file://backend/app/config.py#L15-L98)

#### ç¯å¢ƒå˜é‡åŠ è½½æœºåˆ¶

é…ç½®ç³»ç»Ÿé€šè¿‡.envæ–‡ä»¶å®ç°ç¯å¢ƒå˜é‡çš„é›†ä¸­ç®¡ç†ï¼š

| é…ç½®é¡¹ | ç±»å‹ | é»˜è®¤å€¼ | æè¿° |
|--------|------|--------|------|
| APP_NAME | str | "RAG Studio Backend" | åº”ç”¨åç§° |
| DEBUG | bool | True | è°ƒè¯•æ¨¡å¼å¼€å…³ |
| HOST | str | "0.0.0.0" | æœåŠ¡å™¨ç»‘å®šåœ°å€ |
| PORT | int | 8000 | æœåŠ¡å™¨ç›‘å¬ç«¯å£ |
| API_PREFIX | str | "/api/v1" | APIè·¯å¾„å‰ç¼€ |
| ALLOWED_ORIGINS | str | "http://localhost:3000,http://localhost:3001" | CORSå…è®¸çš„æº |

#### åŠ¨æ€å±æ€§è®¡ç®—

é…ç½®ç±»æä¾›äº†å¤šä¸ªåŠ¨æ€å±æ€§ï¼Œç”¨äºç”Ÿæˆå¤æ‚çš„è¿æ¥å­—ç¬¦ä¸²ï¼š

```mermaid
flowchart LR
A[é…ç½®å±æ€§] --> B[allowed_origins_list]
A --> C[database_url]
A --> D[elasticsearch_url]
B --> E[å­—ç¬¦ä¸²åˆ†å‰²å¤„ç†]
C --> F[MySQLè¿æ¥å­—ç¬¦ä¸²]
D --> G[å¸¦è®¤è¯çš„Elasticsearch URL]
style A fill:#e3f2fd
style E fill:#f3e5f5
style F fill:#f3e5f5
style G fill:#f3e5f5
```

**å›¾è¡¨æ¥æº**
- [config.py](file://backend/app/config.py#L78-L95)

### æ•æ„Ÿä¿¡æ¯ç®¡ç†

#### å®‰å…¨é…ç½®åŸåˆ™

1. **ç¯å¢ƒå˜é‡éš”ç¦»**: æ•æ„Ÿä¿¡æ¯é€šè¿‡.envæ–‡ä»¶ç®¡ç†ï¼Œé¿å…ç¡¬ç¼–ç 
2. **è®¿é—®æ§åˆ¶**: ä»…åœ¨å¿…è¦æ—¶æš´éœ²æ•æ„Ÿé…ç½®
3. **åŠ å¯†ä¼ è¾“**: æ”¯æŒHTTPSå’Œè®¤è¯æœºåˆ¶

#### é…ç½®é¡¹å®‰å…¨çº§åˆ«åˆ†ç±»

| å®‰å…¨çº§åˆ« | é…ç½®é¡¹ | ä¿æŠ¤æªæ–½ |
|----------|--------|----------|
| é«˜ | DB_PASSWORD, ES_PASSWORD, QDRANT_API_KEY, MILVUS_PASSWORD | åŠ å¯†å­˜å‚¨ï¼Œç¯å¢ƒå˜é‡éš”ç¦» |
| ä¸­ | OLLAMA_BASE_URL, CUSTOM_SERVICE_API_KEY | HTTPSä¼ è¾“ï¼Œè®¿é—®é™åˆ¶ |
| ä½ | APP_NAME, DEBUG, HOST, PORT | æ˜æ–‡å­˜å‚¨ï¼Œå…¬å¼€é…ç½® |

**ç« èŠ‚æ¥æº**
- [config.py](file://backend/app/config.py#L1-L99)

## å‘é‡æ•°æ®åº“è¿æ¥é…ç½®

### å¤šæ•°æ®åº“æ”¯æŒæ¶æ„

RAG-Studioæ”¯æŒä¸‰ç§ä¸»æµå‘é‡æ•°æ®åº“ï¼Œæ¯ç§éƒ½æä¾›äº†çµæ´»çš„é…ç½®é€‰é¡¹ã€‚

#### Qdranté…ç½®è¯¦è§£

```mermaid
classDiagram
class QdrantService {
+host : str
+port : int
+api_key : str
+url : str
+client : QdrantClient
+__init__(config)
+create_collection(name, dimension)
+insert_points(collection, points)
+search(collection, vector, top_k)
}
class QdrantConfig {
+host : str
+port : int
+api_key : str
+url : str
}
QdrantService --> QdrantConfig : ä½¿ç”¨
```

**å›¾è¡¨æ¥æº**
- [vector_db_service.py](file://backend/app/services/vector_db_service.py#L203-L284)

#### Elasticsearché…ç½®æœºåˆ¶

```mermaid
flowchart TD
A[é…ç½®è¾“å…¥] --> B{URLæ ¼å¼æ£€æŸ¥}
B --> |å®Œæ•´URL| C[è§£æURLç»„ä»¶]
B --> |ä¸»æœºç«¯å£| D[ç»„åˆä¸»æœºç«¯å£]
C --> E[è®¾ç½®è®¤è¯ä¿¡æ¯]
D --> E
E --> F[å»ºç«‹è¿æ¥]
F --> G[åˆ›å»ºç´¢å¼•æ˜ å°„]
G --> H[è¿”å›æœåŠ¡å®ä¾‹]
style A fill:#e1f5fe
style H fill:#e8f5e8
```

**å›¾è¡¨æ¥æº**
- [vector_db_service.py](file://backend/app/services/vector_db_service.py#L116-L154)

#### Milvusé…ç½®é€‰é¡¹

Milvusé…ç½®æ”¯æŒç”¨æˆ·åå¯†ç è®¤è¯å’Œæ— è®¤è¯ä¸¤ç§æ¨¡å¼ï¼š

| é…ç½®é¡¹ | ç±»å‹ | å¿…éœ€ | æè¿° |
|--------|------|------|------|
| MILVUS_HOST | str | æ˜¯ | MilvusæœåŠ¡å™¨åœ°å€ |
| MILVUS_PORT | int | æ˜¯ | MilvusæœåŠ¡å™¨ç«¯å£ |
| MILVUS_USER | str | å¦ | ç”¨æˆ·åï¼ˆè®¤è¯æ¨¡å¼ï¼‰ |
| MILVUS_PASSWORD | str | å¦ | å¯†ç ï¼ˆè®¤è¯æ¨¡å¼ï¼‰ |

### è¿æ¥æ± ä¸æ€§èƒ½ä¼˜åŒ–

#### è¿æ¥å¤ç”¨ç­–ç•¥

```mermaid
sequenceDiagram
participant App as åº”ç”¨ç¨‹åº
participant Factory as VectorDBServiceFactory
participant Pool as è¿æ¥æ± 
participant DB as å‘é‡æ•°æ®åº“
App->>Factory : è¯·æ±‚æ•°æ®åº“æœåŠ¡
Factory->>Pool : æ£€æŸ¥è¿æ¥æ± 
alt è¿æ¥å¯ç”¨
Pool-->>Factory : è¿”å›ç°æœ‰è¿æ¥
else éœ€è¦æ–°è¿æ¥
Factory->>DB : å»ºç«‹æ–°è¿æ¥
DB-->>Factory : è¿”å›è¿æ¥å®ä¾‹
Factory->>Pool : æ·»åŠ åˆ°è¿æ¥æ± 
end
Factory-->>App : è¿”å›æœåŠ¡å®ä¾‹
```

**å›¾è¡¨æ¥æº**
- [vector_db_service.py](file://backend/app/services/vector_db_service.py#L1089-L1111)

**ç« èŠ‚æ¥æº**
- [vector_db_service.py](file://backend/app/services/vector_db_service.py#L116-L284)
- [config.py](file://backend/app/config.py#L55-L73)

## å®‰å…¨é…ç½®ä¸æœ€ä½³å®è·µ

### CORSé…ç½®å®‰å…¨

RAG-Studioæä¾›äº†çµæ´»çš„CORSé…ç½®æœºåˆ¶ï¼Œæ”¯æŒå¤šåŸŸåè®¿é—®æ§åˆ¶ï¼š

```mermaid
flowchart TD
A[è¯·æ±‚åˆ°è¾¾] --> B[æ£€æŸ¥Originå¤´]
B --> C{æ˜¯å¦åœ¨å…è®¸åˆ—è¡¨ä¸­}
C --> |æ˜¯| D[è®¾ç½®CORSå“åº”å¤´]
C --> |å¦| E[æ‹’ç»è¯·æ±‚]
D --> F[ç»§ç»­å¤„ç†è¯·æ±‚]
E --> G[è¿”å›403 Forbidden]
style A fill:#e1f5fe
style F fill:#e8f5e8
style G fill:#ffebee
```

#### ç”Ÿäº§ç¯å¢ƒå®‰å…¨é…ç½®å»ºè®®

1. **ä¸¥æ ¼åŸŸåç™½åå•**: ä»…å…è®¸ç‰¹å®šçš„å‰ç«¯åŸŸå
2. **HTTPSå¼ºåˆ¶**: åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯ç”¨HTTPS
3. **CORSå¤´éƒ¨æœ€å°åŒ–**: ä»…æš´éœ²å¿…è¦çš„CORSå¤´éƒ¨

### å¼‚å¸¸å¤„ç†å®‰å…¨

```mermaid
classDiagram
class APIException {
+status_code : int
+error_code : str
+message : str
+details : Optional[Any]
+__init__(status_code, error_code, message, details)
}
class ErrorResponse {
+success : bool
+error_code : str
+message : str
+details : Optional[Any]
}
class setup_exception_handlers {
+api_exception_handler()
+validation_exception_handler()
+global_exception_handler()
}
APIException --> ErrorResponse : è½¬æ¢ä¸º
setup_exception_handlers --> APIException : å¤„ç†
```

**å›¾è¡¨æ¥æº**
- [exceptions.py](file://backend/app/core/exceptions.py#L12-L144)

#### æ•æ„Ÿä¿¡æ¯è¿‡æ»¤

å¼‚å¸¸å¤„ç†ç³»ç»Ÿå®ç°äº†æ™ºèƒ½çš„æ•æ„Ÿä¿¡æ¯è¿‡æ»¤ï¼š

| ç¯å¢ƒ | æ•æ„Ÿä¿¡æ¯æ˜¾ç¤º | è¯´æ˜ |
|------|-------------|------|
| å¼€å‘ç¯å¢ƒ | å®Œæ•´é”™è¯¯å †æ ˆ | ä¾¿äºè°ƒè¯• |
| ç”Ÿäº§ç¯å¢ƒ | ç®€åŒ–é”™è¯¯ä¿¡æ¯ | é¿å…æ³„éœ²ç»†èŠ‚ |

**ç« èŠ‚æ¥æº**
- [exceptions.py](file://backend/app/core/exceptions.py#L1-L144)
- [main.py](file://backend/app/main.py#L51-L57)

## æ€§èƒ½è°ƒä¼˜æŒ‡å—

### ä¸­é—´ä»¶æ€§èƒ½ä¼˜åŒ–

#### RequestIDMiddlewareä¼˜åŒ–

1. **UUIDç”Ÿæˆä¼˜åŒ–**: ä½¿ç”¨é«˜æ•ˆçš„UUID v4ç”Ÿæˆç®—æ³•
2. **å†…å­˜ç®¡ç†**: åŠæ—¶æ¸…ç†è¯·æ±‚çŠ¶æ€ï¼Œé¿å…å†…å­˜æ³„æ¼
3. **å¹¶å‘å¤„ç†**: æ”¯æŒé«˜å¹¶å‘åœºæ™¯ä¸‹çš„è¯·æ±‚IDç”Ÿæˆ

#### TimingMiddlewareæ€§èƒ½ç›‘æ§

```mermaid
graph LR
A[è¯·æ±‚å¼€å§‹] --> B[æ—¶é—´æˆ³è®°å½•]
B --> C[ä¸šåŠ¡é€»è¾‘å¤„ç†]
C --> D[æ—¶é—´æˆ³è®¡ç®—]
D --> E[æ€§èƒ½æŒ‡æ ‡æ”¶é›†]
E --> F[æ—¥å¿—è¾“å‡º]
G[æ€§èƒ½é˜ˆå€¼] --> H{è¶…æ—¶æ£€æµ‹}
H --> |æ˜¯| I[å‘Šè­¦è§¦å‘]
H --> |å¦| J[æ­£å¸¸è®°å½•]
style A fill:#e1f5fe
style F fill:#e8f5e8
style I fill:#ffebee
```

### é…ç½®ä¼˜åŒ–å‚æ•°

#### æ•°æ®åº“è¿æ¥ä¼˜åŒ–

| å‚æ•° | å¼€å‘ç¯å¢ƒ | ç”Ÿäº§ç¯å¢ƒ | è¯´æ˜ |
|------|----------|----------|------|
| max_connections | 5 | 20 | æœ€å¤§è¿æ¥æ•° |
| pool_timeout | 5s | 10s | è¿æ¥æ± è¶…æ—¶ |
| connect_timeout | 5s | 10s | è¿æ¥è¶…æ—¶ |
| idle_timeout | 30s | 60s | ç©ºé—²è¿æ¥è¶…æ—¶ |

#### å‘é‡æ•°æ®åº“ä¼˜åŒ–

```mermaid
flowchart TD
A[æŸ¥è¯¢è¯·æ±‚] --> B{ç¼“å­˜æ£€æŸ¥}
B --> |å‘½ä¸­| C[è¿”å›ç¼“å­˜ç»“æœ]
B --> |æœªå‘½ä¸­| D[å‘é‡æ£€ç´¢]
D --> E[ç»“æœæ’åº]
E --> F[æ›´æ–°ç¼“å­˜]
F --> G[è¿”å›ç»“æœ]
H[æ‰¹é‡æ“ä½œ] --> I[é¢„å¤„ç†æ•°æ®]
I --> J[æ‰¹é‡æ’å…¥]
J --> K[ç´¢å¼•æ›´æ–°]
style A fill:#e1f5fe
style C fill:#e8f5e8
style G fill:#e8f5e8
style K fill:#e8f5e8
```

### ç›‘æ§æŒ‡æ ‡å»ºè®®

#### å…³é”®æ€§èƒ½æŒ‡æ ‡(KPI)

1. **è¯·æ±‚å»¶è¿Ÿ**: X-Process-Timeå“åº”å¤´
2. **è¯·æ±‚é¢‘ç‡**: æ¯ç§’è¯·æ±‚æ•°(RPS)
3. **é”™è¯¯ç‡**: 4xx/5xxçŠ¶æ€ç æ¯”ä¾‹
4. **è¿æ¥æ± åˆ©ç”¨ç‡**: æ•°æ®åº“è¿æ¥ä½¿ç”¨æƒ…å†µ

## æ•…éšœæ’é™¤æŒ‡å—

### å¸¸è§é—®é¢˜è¯Šæ–­

#### ä¸­é—´ä»¶é—®é¢˜æ’æŸ¥

```mermaid
flowchart TD
A[ä¸­é—´ä»¶å¼‚å¸¸] --> B{è¯·æ±‚IDç¼ºå¤±}
B --> |æ˜¯| C[æ£€æŸ¥RequestIDMiddleware]
B --> |å¦| D{å¤„ç†æ—¶é—´å¼‚å¸¸}
D --> |æ˜¯| E[æ£€æŸ¥TimingMiddleware]
D --> |å¦| F{å“åº”å¤´é—®é¢˜}
F --> |æ˜¯| G[æ£€æŸ¥ä¸­é—´ä»¶æ³¨å†Œ]
F --> |å¦| H[æ£€æŸ¥å…¶ä»–ä¸­é—´ä»¶]
C --> I[éªŒè¯dispatchæ–¹æ³•]
E --> J[éªŒè¯æ—¶é—´è®¡ç®—]
G --> K[éªŒè¯setup_middlewares]
style A fill:#ffebee
style I fill:#e8f5e8
style J fill:#e8f5e8
style K fill:#e8f5e8
```

#### é…ç½®åŠ è½½é—®é¢˜

1. **ç¯å¢ƒå˜é‡æœªåŠ è½½**: æ£€æŸ¥.envæ–‡ä»¶è·¯å¾„å’Œæ ¼å¼
2. **ç±»å‹è½¬æ¢é”™è¯¯**: éªŒè¯é…ç½®å€¼çš„æ•°æ®ç±»å‹
3. **ä¾èµ–ç¼ºå¤±**: ç¡®è®¤å¿…éœ€çš„PythonåŒ…å®‰è£…

#### æ•°æ®åº“è¿æ¥é—®é¢˜

```mermaid
sequenceDiagram
participant Client as å®¢æˆ·ç«¯
participant App as åº”ç”¨
participant Config as é…ç½®ç³»ç»Ÿ
participant DB as æ•°æ®åº“
Client->>App : å‘é€è¯·æ±‚
App->>Config : è·å–æ•°æ®åº“é…ç½®
Config->>Config : éªŒè¯é…ç½®å®Œæ•´æ€§
alt é…ç½®æ­£ç¡®
Config-->>App : è¿”å›æœ‰æ•ˆé…ç½®
App->>DB : å»ºç«‹è¿æ¥
DB-->>App : è¿æ¥æˆåŠŸ
App-->>Client : è¿”å›ç»“æœ
else é…ç½®é”™è¯¯
Config-->>App : è¿”å›é”™è¯¯é…ç½®
App-->>Client : è¿”å›é…ç½®é”™è¯¯
end
```

### è°ƒè¯•å·¥å…·å’ŒæŠ€å·§

#### æ—¥å¿—åˆ†æ

1. **è¯·æ±‚IDå…³è”**: ä½¿ç”¨X-Request-IDè¿½è¸ªç‰¹å®šè¯·æ±‚
2. **æ—¶é—´çº¿åˆ†æ**: ç»“åˆX-Process-Timeåˆ†ææ€§èƒ½ç“¶é¢ˆ
3. **é”™è¯¯å †æ ˆ**: å¼€å‘ç¯å¢ƒä¸‹çš„è¯¦ç»†é”™è¯¯ä¿¡æ¯

#### æ€§èƒ½åˆ†æ

1. **æ…¢æŸ¥è¯¢è¯†åˆ«**: é€šè¿‡TimingMiddlewareè¯†åˆ«æ…¢è¯·æ±‚
2. **èµ„æºä½¿ç”¨ç›‘æ§**: ç›‘æ§å†…å­˜å’ŒCPUä½¿ç”¨æƒ…å†µ
3. **å¹¶å‘å‹åŠ›æµ‹è¯•**: æµ‹è¯•ç³»ç»Ÿåœ¨é«˜å¹¶å‘ä¸‹çš„è¡¨ç°

**ç« èŠ‚æ¥æº**
- [middleware.py](file://backend/app/core/middleware.py#L1-L62)
- [config.py](file://backend/app/config.py#L1-L99)

## æ€»ç»“

RAG-Studioçš„ä¸­é—´ä»¶ä¸é…ç½®ç®¡ç†ç³»ç»Ÿå±•ç°äº†ç°ä»£Webåº”ç”¨çš„æœ€ä½³å®è·µã€‚é€šè¿‡RequestIDMiddlewareå’ŒTimingMiddlewareçš„ååŒå·¥ä½œï¼Œç³»ç»Ÿå®ç°äº†å®Œæ•´çš„å…¨é“¾è·¯è¿½è¸ªå’Œæ€§èƒ½ç›‘æ§èƒ½åŠ›ã€‚åŸºäºPydantic Settingsçš„é…ç½®ç®¡ç†æœºåˆ¶ç¡®ä¿äº†åº”ç”¨çš„çµæ´»æ€§å’Œå®‰å…¨æ€§ï¼Œæ”¯æŒå¤šç¯å¢ƒéƒ¨ç½²å’ŒåŠ¨æ€é…ç½®æ›´æ–°ã€‚

ç³»ç»Ÿçš„å‘é‡æ•°æ®åº“è¿æ¥é…ç½®æä¾›äº†å¯¹å¤šç§ä¸»æµå‘é‡æ•°æ®åº“çš„ç»Ÿä¸€æŠ½è±¡ï¼Œç®€åŒ–äº†ä¸åŒæ•°æ®åº“é—´çš„åˆ‡æ¢æˆæœ¬ã€‚å®‰å…¨é…ç½®å’Œå¼‚å¸¸å¤„ç†æœºåˆ¶ç¡®ä¿äº†ç”Ÿäº§ç¯å¢ƒçš„ç¨³å®šæ€§å’Œå®‰å…¨æ€§ã€‚

é€šè¿‡åˆç†çš„æ€§èƒ½è°ƒä¼˜å’Œç›‘æ§æŒ‡æ ‡è®¾ç½®ï¼Œå¼€å‘è€…å¯ä»¥æ„å»ºå‡ºé«˜æ€§èƒ½ã€é«˜å¯ç”¨çš„ä¼ä¸šçº§åº”ç”¨ã€‚è¿™å¥—ä¸­é—´ä»¶ä¸é…ç½®ç®¡ç†æ–¹æ¡ˆä¸ä»…æ»¡è¶³äº†å½“å‰çš„åŠŸèƒ½éœ€æ±‚ï¼Œè¿˜ä¸ºæœªæ¥çš„æ‰©å±•å’Œæ¼”è¿›å¥ å®šäº†åšå®çš„åŸºç¡€ã€‚